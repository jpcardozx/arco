revoke delete on table "public"."agency_insights" from "anon";

revoke insert on table "public"."agency_insights" from "anon";

revoke references on table "public"."agency_insights" from "anon";

revoke select on table "public"."agency_insights" from "anon";

revoke trigger on table "public"."agency_insights" from "anon";

revoke truncate on table "public"."agency_insights" from "anon";

revoke update on table "public"."agency_insights" from "anon";

revoke delete on table "public"."agency_insights" from "authenticated";

revoke insert on table "public"."agency_insights" from "authenticated";

revoke references on table "public"."agency_insights" from "authenticated";

revoke select on table "public"."agency_insights" from "authenticated";

revoke trigger on table "public"."agency_insights" from "authenticated";

revoke truncate on table "public"."agency_insights" from "authenticated";

revoke update on table "public"."agency_insights" from "authenticated";

revoke delete on table "public"."agency_insights" from "service_role";

revoke insert on table "public"."agency_insights" from "service_role";

revoke references on table "public"."agency_insights" from "service_role";

revoke select on table "public"."agency_insights" from "service_role";

revoke trigger on table "public"."agency_insights" from "service_role";

revoke truncate on table "public"."agency_insights" from "service_role";

revoke update on table "public"."agency_insights" from "service_role";

revoke delete on table "public"."analysis_requests" from "anon";

revoke insert on table "public"."analysis_requests" from "anon";

revoke references on table "public"."analysis_requests" from "anon";

revoke select on table "public"."analysis_requests" from "anon";

revoke trigger on table "public"."analysis_requests" from "anon";

revoke truncate on table "public"."analysis_requests" from "anon";

revoke update on table "public"."analysis_requests" from "anon";

revoke delete on table "public"."analysis_requests" from "authenticated";

revoke insert on table "public"."analysis_requests" from "authenticated";

revoke references on table "public"."analysis_requests" from "authenticated";

revoke select on table "public"."analysis_requests" from "authenticated";

revoke trigger on table "public"."analysis_requests" from "authenticated";

revoke truncate on table "public"."analysis_requests" from "authenticated";

revoke update on table "public"."analysis_requests" from "authenticated";

revoke delete on table "public"."analysis_requests" from "service_role";

revoke insert on table "public"."analysis_requests" from "service_role";

revoke references on table "public"."analysis_requests" from "service_role";

revoke select on table "public"."analysis_requests" from "service_role";

revoke trigger on table "public"."analysis_requests" from "service_role";

revoke truncate on table "public"."analysis_requests" from "service_role";

revoke update on table "public"."analysis_requests" from "service_role";

revoke delete on table "public"."analysis_results" from "anon";

revoke insert on table "public"."analysis_results" from "anon";

revoke references on table "public"."analysis_results" from "anon";

revoke select on table "public"."analysis_results" from "anon";

revoke trigger on table "public"."analysis_results" from "anon";

revoke truncate on table "public"."analysis_results" from "anon";

revoke update on table "public"."analysis_results" from "anon";

revoke delete on table "public"."analysis_results" from "authenticated";

revoke insert on table "public"."analysis_results" from "authenticated";

revoke references on table "public"."analysis_results" from "authenticated";

revoke select on table "public"."analysis_results" from "authenticated";

revoke trigger on table "public"."analysis_results" from "authenticated";

revoke truncate on table "public"."analysis_results" from "authenticated";

revoke update on table "public"."analysis_results" from "authenticated";

revoke delete on table "public"."analysis_results" from "service_role";

revoke insert on table "public"."analysis_results" from "service_role";

revoke references on table "public"."analysis_results" from "service_role";

revoke select on table "public"."analysis_results" from "service_role";

revoke trigger on table "public"."analysis_results" from "service_role";

revoke truncate on table "public"."analysis_results" from "service_role";

revoke update on table "public"."analysis_results" from "service_role";

revoke delete on table "public"."analytics_data" from "anon";

revoke insert on table "public"."analytics_data" from "anon";

revoke references on table "public"."analytics_data" from "anon";

revoke select on table "public"."analytics_data" from "anon";

revoke trigger on table "public"."analytics_data" from "anon";

revoke truncate on table "public"."analytics_data" from "anon";

revoke update on table "public"."analytics_data" from "anon";

revoke delete on table "public"."analytics_data" from "authenticated";

revoke insert on table "public"."analytics_data" from "authenticated";

revoke references on table "public"."analytics_data" from "authenticated";

revoke select on table "public"."analytics_data" from "authenticated";

revoke trigger on table "public"."analytics_data" from "authenticated";

revoke truncate on table "public"."analytics_data" from "authenticated";

revoke update on table "public"."analytics_data" from "authenticated";

revoke delete on table "public"."analytics_data" from "service_role";

revoke insert on table "public"."analytics_data" from "service_role";

revoke references on table "public"."analytics_data" from "service_role";

revoke select on table "public"."analytics_data" from "service_role";

revoke trigger on table "public"."analytics_data" from "service_role";

revoke truncate on table "public"."analytics_data" from "service_role";

revoke update on table "public"."analytics_data" from "service_role";

revoke delete on table "public"."booking_notes" from "anon";

revoke insert on table "public"."booking_notes" from "anon";

revoke references on table "public"."booking_notes" from "anon";

revoke select on table "public"."booking_notes" from "anon";

revoke trigger on table "public"."booking_notes" from "anon";

revoke truncate on table "public"."booking_notes" from "anon";

revoke update on table "public"."booking_notes" from "anon";

revoke delete on table "public"."booking_notes" from "authenticated";

revoke insert on table "public"."booking_notes" from "authenticated";

revoke references on table "public"."booking_notes" from "authenticated";

revoke select on table "public"."booking_notes" from "authenticated";

revoke trigger on table "public"."booking_notes" from "authenticated";

revoke truncate on table "public"."booking_notes" from "authenticated";

revoke update on table "public"."booking_notes" from "authenticated";

revoke delete on table "public"."booking_notes" from "service_role";

revoke insert on table "public"."booking_notes" from "service_role";

revoke references on table "public"."booking_notes" from "service_role";

revoke select on table "public"."booking_notes" from "service_role";

revoke trigger on table "public"."booking_notes" from "service_role";

revoke truncate on table "public"."booking_notes" from "service_role";

revoke update on table "public"."booking_notes" from "service_role";

revoke delete on table "public"."calendar_events" from "anon";

revoke insert on table "public"."calendar_events" from "anon";

revoke references on table "public"."calendar_events" from "anon";

revoke select on table "public"."calendar_events" from "anon";

revoke trigger on table "public"."calendar_events" from "anon";

revoke truncate on table "public"."calendar_events" from "anon";

revoke update on table "public"."calendar_events" from "anon";

revoke delete on table "public"."calendar_events" from "authenticated";

revoke insert on table "public"."calendar_events" from "authenticated";

revoke references on table "public"."calendar_events" from "authenticated";

revoke select on table "public"."calendar_events" from "authenticated";

revoke trigger on table "public"."calendar_events" from "authenticated";

revoke truncate on table "public"."calendar_events" from "authenticated";

revoke update on table "public"."calendar_events" from "authenticated";

revoke delete on table "public"."calendar_events" from "service_role";

revoke insert on table "public"."calendar_events" from "service_role";

revoke references on table "public"."calendar_events" from "service_role";

revoke select on table "public"."calendar_events" from "service_role";

revoke trigger on table "public"."calendar_events" from "service_role";

revoke truncate on table "public"."calendar_events" from "service_role";

revoke update on table "public"."calendar_events" from "service_role";

revoke delete on table "public"."campaign_metrics" from "anon";

revoke insert on table "public"."campaign_metrics" from "anon";

revoke references on table "public"."campaign_metrics" from "anon";

revoke select on table "public"."campaign_metrics" from "anon";

revoke trigger on table "public"."campaign_metrics" from "anon";

revoke truncate on table "public"."campaign_metrics" from "anon";

revoke update on table "public"."campaign_metrics" from "anon";

revoke delete on table "public"."campaign_metrics" from "authenticated";

revoke insert on table "public"."campaign_metrics" from "authenticated";

revoke references on table "public"."campaign_metrics" from "authenticated";

revoke select on table "public"."campaign_metrics" from "authenticated";

revoke trigger on table "public"."campaign_metrics" from "authenticated";

revoke truncate on table "public"."campaign_metrics" from "authenticated";

revoke update on table "public"."campaign_metrics" from "authenticated";

revoke delete on table "public"."campaign_metrics" from "service_role";

revoke insert on table "public"."campaign_metrics" from "service_role";

revoke references on table "public"."campaign_metrics" from "service_role";

revoke select on table "public"."campaign_metrics" from "service_role";

revoke trigger on table "public"."campaign_metrics" from "service_role";

revoke truncate on table "public"."campaign_metrics" from "service_role";

revoke update on table "public"."campaign_metrics" from "service_role";

revoke delete on table "public"."campaigns" from "anon";

revoke insert on table "public"."campaigns" from "anon";

revoke references on table "public"."campaigns" from "anon";

revoke select on table "public"."campaigns" from "anon";

revoke trigger on table "public"."campaigns" from "anon";

revoke truncate on table "public"."campaigns" from "anon";

revoke update on table "public"."campaigns" from "anon";

revoke delete on table "public"."campaigns" from "authenticated";

revoke insert on table "public"."campaigns" from "authenticated";

revoke references on table "public"."campaigns" from "authenticated";

revoke select on table "public"."campaigns" from "authenticated";

revoke trigger on table "public"."campaigns" from "authenticated";

revoke truncate on table "public"."campaigns" from "authenticated";

revoke update on table "public"."campaigns" from "authenticated";

revoke delete on table "public"."campaigns" from "service_role";

revoke insert on table "public"."campaigns" from "service_role";

revoke references on table "public"."campaigns" from "service_role";

revoke select on table "public"."campaigns" from "service_role";

revoke trigger on table "public"."campaigns" from "service_role";

revoke truncate on table "public"."campaigns" from "service_role";

revoke update on table "public"."campaigns" from "service_role";

revoke delete on table "public"."checklist_activity_logs" from "anon";

revoke insert on table "public"."checklist_activity_logs" from "anon";

revoke references on table "public"."checklist_activity_logs" from "anon";

revoke select on table "public"."checklist_activity_logs" from "anon";

revoke trigger on table "public"."checklist_activity_logs" from "anon";

revoke truncate on table "public"."checklist_activity_logs" from "anon";

revoke update on table "public"."checklist_activity_logs" from "anon";

revoke delete on table "public"."checklist_activity_logs" from "authenticated";

revoke insert on table "public"."checklist_activity_logs" from "authenticated";

revoke references on table "public"."checklist_activity_logs" from "authenticated";

revoke select on table "public"."checklist_activity_logs" from "authenticated";

revoke trigger on table "public"."checklist_activity_logs" from "authenticated";

revoke truncate on table "public"."checklist_activity_logs" from "authenticated";

revoke update on table "public"."checklist_activity_logs" from "authenticated";

revoke delete on table "public"."checklist_activity_logs" from "service_role";

revoke insert on table "public"."checklist_activity_logs" from "service_role";

revoke references on table "public"."checklist_activity_logs" from "service_role";

revoke select on table "public"."checklist_activity_logs" from "service_role";

revoke trigger on table "public"."checklist_activity_logs" from "service_role";

revoke truncate on table "public"."checklist_activity_logs" from "service_role";

revoke update on table "public"."checklist_activity_logs" from "service_role";

revoke delete on table "public"."checklist_items" from "anon";

revoke insert on table "public"."checklist_items" from "anon";

revoke references on table "public"."checklist_items" from "anon";

revoke select on table "public"."checklist_items" from "anon";

revoke trigger on table "public"."checklist_items" from "anon";

revoke truncate on table "public"."checklist_items" from "anon";

revoke update on table "public"."checklist_items" from "anon";

revoke delete on table "public"."checklist_items" from "authenticated";

revoke insert on table "public"."checklist_items" from "authenticated";

revoke references on table "public"."checklist_items" from "authenticated";

revoke select on table "public"."checklist_items" from "authenticated";

revoke trigger on table "public"."checklist_items" from "authenticated";

revoke truncate on table "public"."checklist_items" from "authenticated";

revoke update on table "public"."checklist_items" from "authenticated";

revoke delete on table "public"."checklist_items" from "service_role";

revoke insert on table "public"."checklist_items" from "service_role";

revoke references on table "public"."checklist_items" from "service_role";

revoke select on table "public"."checklist_items" from "service_role";

revoke trigger on table "public"."checklist_items" from "service_role";

revoke truncate on table "public"."checklist_items" from "service_role";

revoke update on table "public"."checklist_items" from "service_role";

revoke delete on table "public"."checklist_relationships" from "anon";

revoke insert on table "public"."checklist_relationships" from "anon";

revoke references on table "public"."checklist_relationships" from "anon";

revoke select on table "public"."checklist_relationships" from "anon";

revoke trigger on table "public"."checklist_relationships" from "anon";

revoke truncate on table "public"."checklist_relationships" from "anon";

revoke update on table "public"."checklist_relationships" from "anon";

revoke delete on table "public"."checklist_relationships" from "authenticated";

revoke insert on table "public"."checklist_relationships" from "authenticated";

revoke references on table "public"."checklist_relationships" from "authenticated";

revoke select on table "public"."checklist_relationships" from "authenticated";

revoke trigger on table "public"."checklist_relationships" from "authenticated";

revoke truncate on table "public"."checklist_relationships" from "authenticated";

revoke update on table "public"."checklist_relationships" from "authenticated";

revoke delete on table "public"."checklist_relationships" from "service_role";

revoke insert on table "public"."checklist_relationships" from "service_role";

revoke references on table "public"."checklist_relationships" from "service_role";

revoke select on table "public"."checklist_relationships" from "service_role";

revoke trigger on table "public"."checklist_relationships" from "service_role";

revoke truncate on table "public"."checklist_relationships" from "service_role";

revoke update on table "public"."checklist_relationships" from "service_role";

revoke delete on table "public"."checklist_templates" from "anon";

revoke insert on table "public"."checklist_templates" from "anon";

revoke references on table "public"."checklist_templates" from "anon";

revoke select on table "public"."checklist_templates" from "anon";

revoke trigger on table "public"."checklist_templates" from "anon";

revoke truncate on table "public"."checklist_templates" from "anon";

revoke update on table "public"."checklist_templates" from "anon";

revoke delete on table "public"."checklist_templates" from "authenticated";

revoke insert on table "public"."checklist_templates" from "authenticated";

revoke references on table "public"."checklist_templates" from "authenticated";

revoke select on table "public"."checklist_templates" from "authenticated";

revoke trigger on table "public"."checklist_templates" from "authenticated";

revoke truncate on table "public"."checklist_templates" from "authenticated";

revoke update on table "public"."checklist_templates" from "authenticated";

revoke delete on table "public"."checklist_templates" from "service_role";

revoke insert on table "public"."checklist_templates" from "service_role";

revoke references on table "public"."checklist_templates" from "service_role";

revoke select on table "public"."checklist_templates" from "service_role";

revoke trigger on table "public"."checklist_templates" from "service_role";

revoke truncate on table "public"."checklist_templates" from "service_role";

revoke update on table "public"."checklist_templates" from "service_role";

revoke delete on table "public"."checklist_verifications" from "anon";

revoke insert on table "public"."checklist_verifications" from "anon";

revoke references on table "public"."checklist_verifications" from "anon";

revoke select on table "public"."checklist_verifications" from "anon";

revoke trigger on table "public"."checklist_verifications" from "anon";

revoke truncate on table "public"."checklist_verifications" from "anon";

revoke update on table "public"."checklist_verifications" from "anon";

revoke delete on table "public"."checklist_verifications" from "authenticated";

revoke insert on table "public"."checklist_verifications" from "authenticated";

revoke references on table "public"."checklist_verifications" from "authenticated";

revoke select on table "public"."checklist_verifications" from "authenticated";

revoke trigger on table "public"."checklist_verifications" from "authenticated";

revoke truncate on table "public"."checklist_verifications" from "authenticated";

revoke update on table "public"."checklist_verifications" from "authenticated";

revoke delete on table "public"."checklist_verifications" from "service_role";

revoke insert on table "public"."checklist_verifications" from "service_role";

revoke references on table "public"."checklist_verifications" from "service_role";

revoke select on table "public"."checklist_verifications" from "service_role";

revoke trigger on table "public"."checklist_verifications" from "service_role";

revoke truncate on table "public"."checklist_verifications" from "service_role";

revoke update on table "public"."checklist_verifications" from "service_role";

revoke delete on table "public"."client_interactions" from "anon";

revoke insert on table "public"."client_interactions" from "anon";

revoke references on table "public"."client_interactions" from "anon";

revoke select on table "public"."client_interactions" from "anon";

revoke trigger on table "public"."client_interactions" from "anon";

revoke truncate on table "public"."client_interactions" from "anon";

revoke update on table "public"."client_interactions" from "anon";

revoke delete on table "public"."client_interactions" from "authenticated";

revoke insert on table "public"."client_interactions" from "authenticated";

revoke references on table "public"."client_interactions" from "authenticated";

revoke select on table "public"."client_interactions" from "authenticated";

revoke trigger on table "public"."client_interactions" from "authenticated";

revoke truncate on table "public"."client_interactions" from "authenticated";

revoke update on table "public"."client_interactions" from "authenticated";

revoke delete on table "public"."client_interactions" from "service_role";

revoke insert on table "public"."client_interactions" from "service_role";

revoke references on table "public"."client_interactions" from "service_role";

revoke select on table "public"."client_interactions" from "service_role";

revoke trigger on table "public"."client_interactions" from "service_role";

revoke truncate on table "public"."client_interactions" from "service_role";

revoke update on table "public"."client_interactions" from "service_role";

revoke delete on table "public"."client_profiles" from "anon";

revoke insert on table "public"."client_profiles" from "anon";

revoke references on table "public"."client_profiles" from "anon";

revoke select on table "public"."client_profiles" from "anon";

revoke trigger on table "public"."client_profiles" from "anon";

revoke truncate on table "public"."client_profiles" from "anon";

revoke update on table "public"."client_profiles" from "anon";

revoke delete on table "public"."client_profiles" from "authenticated";

revoke insert on table "public"."client_profiles" from "authenticated";

revoke references on table "public"."client_profiles" from "authenticated";

revoke select on table "public"."client_profiles" from "authenticated";

revoke trigger on table "public"."client_profiles" from "authenticated";

revoke truncate on table "public"."client_profiles" from "authenticated";

revoke update on table "public"."client_profiles" from "authenticated";

revoke delete on table "public"."client_profiles" from "service_role";

revoke insert on table "public"."client_profiles" from "service_role";

revoke references on table "public"."client_profiles" from "service_role";

revoke select on table "public"."client_profiles" from "service_role";

revoke trigger on table "public"."client_profiles" from "service_role";

revoke truncate on table "public"."client_profiles" from "service_role";

revoke update on table "public"."client_profiles" from "service_role";

revoke delete on table "public"."clients" from "anon";

revoke insert on table "public"."clients" from "anon";

revoke references on table "public"."clients" from "anon";

revoke select on table "public"."clients" from "anon";

revoke trigger on table "public"."clients" from "anon";

revoke truncate on table "public"."clients" from "anon";

revoke update on table "public"."clients" from "anon";

revoke delete on table "public"."clients" from "authenticated";

revoke insert on table "public"."clients" from "authenticated";

revoke references on table "public"."clients" from "authenticated";

revoke select on table "public"."clients" from "authenticated";

revoke trigger on table "public"."clients" from "authenticated";

revoke truncate on table "public"."clients" from "authenticated";

revoke update on table "public"."clients" from "authenticated";

revoke delete on table "public"."clients" from "service_role";

revoke insert on table "public"."clients" from "service_role";

revoke references on table "public"."clients" from "service_role";

revoke select on table "public"."clients" from "service_role";

revoke trigger on table "public"."clients" from "service_role";

revoke truncate on table "public"."clients" from "service_role";

revoke update on table "public"."clients" from "service_role";

revoke delete on table "public"."cloud_files" from "anon";

revoke insert on table "public"."cloud_files" from "anon";

revoke references on table "public"."cloud_files" from "anon";

revoke select on table "public"."cloud_files" from "anon";

revoke trigger on table "public"."cloud_files" from "anon";

revoke truncate on table "public"."cloud_files" from "anon";

revoke update on table "public"."cloud_files" from "anon";

revoke delete on table "public"."cloud_files" from "authenticated";

revoke insert on table "public"."cloud_files" from "authenticated";

revoke references on table "public"."cloud_files" from "authenticated";

revoke select on table "public"."cloud_files" from "authenticated";

revoke trigger on table "public"."cloud_files" from "authenticated";

revoke truncate on table "public"."cloud_files" from "authenticated";

revoke update on table "public"."cloud_files" from "authenticated";

revoke delete on table "public"."cloud_files" from "service_role";

revoke insert on table "public"."cloud_files" from "service_role";

revoke references on table "public"."cloud_files" from "service_role";

revoke select on table "public"."cloud_files" from "service_role";

revoke trigger on table "public"."cloud_files" from "service_role";

revoke truncate on table "public"."cloud_files" from "service_role";

revoke update on table "public"."cloud_files" from "service_role";

revoke delete on table "public"."commission_goals" from "anon";

revoke insert on table "public"."commission_goals" from "anon";

revoke references on table "public"."commission_goals" from "anon";

revoke select on table "public"."commission_goals" from "anon";

revoke trigger on table "public"."commission_goals" from "anon";

revoke truncate on table "public"."commission_goals" from "anon";

revoke update on table "public"."commission_goals" from "anon";

revoke delete on table "public"."commission_goals" from "authenticated";

revoke insert on table "public"."commission_goals" from "authenticated";

revoke references on table "public"."commission_goals" from "authenticated";

revoke select on table "public"."commission_goals" from "authenticated";

revoke trigger on table "public"."commission_goals" from "authenticated";

revoke truncate on table "public"."commission_goals" from "authenticated";

revoke update on table "public"."commission_goals" from "authenticated";

revoke delete on table "public"."commission_goals" from "service_role";

revoke insert on table "public"."commission_goals" from "service_role";

revoke references on table "public"."commission_goals" from "service_role";

revoke select on table "public"."commission_goals" from "service_role";

revoke trigger on table "public"."commission_goals" from "service_role";

revoke truncate on table "public"."commission_goals" from "service_role";

revoke update on table "public"."commission_goals" from "service_role";

revoke delete on table "public"."commissions" from "anon";

revoke insert on table "public"."commissions" from "anon";

revoke references on table "public"."commissions" from "anon";

revoke select on table "public"."commissions" from "anon";

revoke trigger on table "public"."commissions" from "anon";

revoke truncate on table "public"."commissions" from "anon";

revoke update on table "public"."commissions" from "anon";

revoke delete on table "public"."commissions" from "authenticated";

revoke insert on table "public"."commissions" from "authenticated";

revoke references on table "public"."commissions" from "authenticated";

revoke select on table "public"."commissions" from "authenticated";

revoke trigger on table "public"."commissions" from "authenticated";

revoke truncate on table "public"."commissions" from "authenticated";

revoke update on table "public"."commissions" from "authenticated";

revoke delete on table "public"."commissions" from "service_role";

revoke insert on table "public"."commissions" from "service_role";

revoke references on table "public"."commissions" from "service_role";

revoke select on table "public"."commissions" from "service_role";

revoke trigger on table "public"."commissions" from "service_role";

revoke truncate on table "public"."commissions" from "service_role";

revoke update on table "public"."commissions" from "service_role";

revoke delete on table "public"."consultant_availability" from "anon";

revoke insert on table "public"."consultant_availability" from "anon";

revoke references on table "public"."consultant_availability" from "anon";

revoke select on table "public"."consultant_availability" from "anon";

revoke trigger on table "public"."consultant_availability" from "anon";

revoke truncate on table "public"."consultant_availability" from "anon";

revoke update on table "public"."consultant_availability" from "anon";

revoke delete on table "public"."consultant_availability" from "authenticated";

revoke insert on table "public"."consultant_availability" from "authenticated";

revoke references on table "public"."consultant_availability" from "authenticated";

revoke select on table "public"."consultant_availability" from "authenticated";

revoke trigger on table "public"."consultant_availability" from "authenticated";

revoke truncate on table "public"."consultant_availability" from "authenticated";

revoke update on table "public"."consultant_availability" from "authenticated";

revoke delete on table "public"."consultant_availability" from "service_role";

revoke insert on table "public"."consultant_availability" from "service_role";

revoke references on table "public"."consultant_availability" from "service_role";

revoke select on table "public"."consultant_availability" from "service_role";

revoke trigger on table "public"."consultant_availability" from "service_role";

revoke truncate on table "public"."consultant_availability" from "service_role";

revoke update on table "public"."consultant_availability" from "service_role";

revoke delete on table "public"."consultoria_bookings" from "anon";

revoke insert on table "public"."consultoria_bookings" from "anon";

revoke references on table "public"."consultoria_bookings" from "anon";

revoke select on table "public"."consultoria_bookings" from "anon";

revoke trigger on table "public"."consultoria_bookings" from "anon";

revoke truncate on table "public"."consultoria_bookings" from "anon";

revoke update on table "public"."consultoria_bookings" from "anon";

revoke delete on table "public"."consultoria_bookings" from "authenticated";

revoke insert on table "public"."consultoria_bookings" from "authenticated";

revoke references on table "public"."consultoria_bookings" from "authenticated";

revoke select on table "public"."consultoria_bookings" from "authenticated";

revoke trigger on table "public"."consultoria_bookings" from "authenticated";

revoke truncate on table "public"."consultoria_bookings" from "authenticated";

revoke update on table "public"."consultoria_bookings" from "authenticated";

revoke delete on table "public"."consultoria_bookings" from "service_role";

revoke insert on table "public"."consultoria_bookings" from "service_role";

revoke references on table "public"."consultoria_bookings" from "service_role";

revoke select on table "public"."consultoria_bookings" from "service_role";

revoke trigger on table "public"."consultoria_bookings" from "service_role";

revoke truncate on table "public"."consultoria_bookings" from "service_role";

revoke update on table "public"."consultoria_bookings" from "service_role";

revoke delete on table "public"."consultoria_types" from "anon";

revoke insert on table "public"."consultoria_types" from "anon";

revoke references on table "public"."consultoria_types" from "anon";

revoke select on table "public"."consultoria_types" from "anon";

revoke trigger on table "public"."consultoria_types" from "anon";

revoke truncate on table "public"."consultoria_types" from "anon";

revoke update on table "public"."consultoria_types" from "anon";

revoke delete on table "public"."consultoria_types" from "authenticated";

revoke insert on table "public"."consultoria_types" from "authenticated";

revoke references on table "public"."consultoria_types" from "authenticated";

revoke select on table "public"."consultoria_types" from "authenticated";

revoke trigger on table "public"."consultoria_types" from "authenticated";

revoke truncate on table "public"."consultoria_types" from "authenticated";

revoke update on table "public"."consultoria_types" from "authenticated";

revoke delete on table "public"."consultoria_types" from "service_role";

revoke insert on table "public"."consultoria_types" from "service_role";

revoke references on table "public"."consultoria_types" from "service_role";

revoke select on table "public"."consultoria_types" from "service_role";

revoke trigger on table "public"."consultoria_types" from "service_role";

revoke truncate on table "public"."consultoria_types" from "service_role";

revoke update on table "public"."consultoria_types" from "service_role";

revoke delete on table "public"."discount_codes" from "anon";

revoke insert on table "public"."discount_codes" from "anon";

revoke references on table "public"."discount_codes" from "anon";

revoke select on table "public"."discount_codes" from "anon";

revoke trigger on table "public"."discount_codes" from "anon";

revoke truncate on table "public"."discount_codes" from "anon";

revoke update on table "public"."discount_codes" from "anon";

revoke delete on table "public"."discount_codes" from "authenticated";

revoke insert on table "public"."discount_codes" from "authenticated";

revoke references on table "public"."discount_codes" from "authenticated";

revoke select on table "public"."discount_codes" from "authenticated";

revoke trigger on table "public"."discount_codes" from "authenticated";

revoke truncate on table "public"."discount_codes" from "authenticated";

revoke update on table "public"."discount_codes" from "authenticated";

revoke delete on table "public"."discount_codes" from "service_role";

revoke insert on table "public"."discount_codes" from "service_role";

revoke references on table "public"."discount_codes" from "service_role";

revoke select on table "public"."discount_codes" from "service_role";

revoke trigger on table "public"."discount_codes" from "service_role";

revoke truncate on table "public"."discount_codes" from "service_role";

revoke update on table "public"."discount_codes" from "service_role";

revoke delete on table "public"."domain_monitoring" from "anon";

revoke insert on table "public"."domain_monitoring" from "anon";

revoke references on table "public"."domain_monitoring" from "anon";

revoke select on table "public"."domain_monitoring" from "anon";

revoke trigger on table "public"."domain_monitoring" from "anon";

revoke truncate on table "public"."domain_monitoring" from "anon";

revoke update on table "public"."domain_monitoring" from "anon";

revoke delete on table "public"."domain_monitoring" from "authenticated";

revoke insert on table "public"."domain_monitoring" from "authenticated";

revoke references on table "public"."domain_monitoring" from "authenticated";

revoke select on table "public"."domain_monitoring" from "authenticated";

revoke trigger on table "public"."domain_monitoring" from "authenticated";

revoke truncate on table "public"."domain_monitoring" from "authenticated";

revoke update on table "public"."domain_monitoring" from "authenticated";

revoke delete on table "public"."domain_monitoring" from "service_role";

revoke insert on table "public"."domain_monitoring" from "service_role";

revoke references on table "public"."domain_monitoring" from "service_role";

revoke select on table "public"."domain_monitoring" from "service_role";

revoke trigger on table "public"."domain_monitoring" from "service_role";

revoke truncate on table "public"."domain_monitoring" from "service_role";

revoke update on table "public"."domain_monitoring" from "service_role";

revoke delete on table "public"."domain_validations" from "anon";

revoke insert on table "public"."domain_validations" from "anon";

revoke references on table "public"."domain_validations" from "anon";

revoke select on table "public"."domain_validations" from "anon";

revoke trigger on table "public"."domain_validations" from "anon";

revoke truncate on table "public"."domain_validations" from "anon";

revoke update on table "public"."domain_validations" from "anon";

revoke delete on table "public"."domain_validations" from "authenticated";

revoke insert on table "public"."domain_validations" from "authenticated";

revoke references on table "public"."domain_validations" from "authenticated";

revoke select on table "public"."domain_validations" from "authenticated";

revoke trigger on table "public"."domain_validations" from "authenticated";

revoke truncate on table "public"."domain_validations" from "authenticated";

revoke update on table "public"."domain_validations" from "authenticated";

revoke delete on table "public"."domain_validations" from "service_role";

revoke insert on table "public"."domain_validations" from "service_role";

revoke references on table "public"."domain_validations" from "service_role";

revoke select on table "public"."domain_validations" from "service_role";

revoke trigger on table "public"."domain_validations" from "service_role";

revoke truncate on table "public"."domain_validations" from "service_role";

revoke update on table "public"."domain_validations" from "service_role";

revoke delete on table "public"."email_accounts" from "anon";

revoke insert on table "public"."email_accounts" from "anon";

revoke references on table "public"."email_accounts" from "anon";

revoke select on table "public"."email_accounts" from "anon";

revoke trigger on table "public"."email_accounts" from "anon";

revoke truncate on table "public"."email_accounts" from "anon";

revoke update on table "public"."email_accounts" from "anon";

revoke delete on table "public"."email_accounts" from "authenticated";

revoke insert on table "public"."email_accounts" from "authenticated";

revoke references on table "public"."email_accounts" from "authenticated";

revoke select on table "public"."email_accounts" from "authenticated";

revoke trigger on table "public"."email_accounts" from "authenticated";

revoke truncate on table "public"."email_accounts" from "authenticated";

revoke update on table "public"."email_accounts" from "authenticated";

revoke delete on table "public"."email_accounts" from "service_role";

revoke insert on table "public"."email_accounts" from "service_role";

revoke references on table "public"."email_accounts" from "service_role";

revoke select on table "public"."email_accounts" from "service_role";

revoke trigger on table "public"."email_accounts" from "service_role";

revoke truncate on table "public"."email_accounts" from "service_role";

revoke update on table "public"."email_accounts" from "service_role";

revoke delete on table "public"."email_messages" from "anon";

revoke insert on table "public"."email_messages" from "anon";

revoke references on table "public"."email_messages" from "anon";

revoke select on table "public"."email_messages" from "anon";

revoke trigger on table "public"."email_messages" from "anon";

revoke truncate on table "public"."email_messages" from "anon";

revoke update on table "public"."email_messages" from "anon";

revoke delete on table "public"."email_messages" from "authenticated";

revoke insert on table "public"."email_messages" from "authenticated";

revoke references on table "public"."email_messages" from "authenticated";

revoke select on table "public"."email_messages" from "authenticated";

revoke trigger on table "public"."email_messages" from "authenticated";

revoke truncate on table "public"."email_messages" from "authenticated";

revoke update on table "public"."email_messages" from "authenticated";

revoke delete on table "public"."email_messages" from "service_role";

revoke insert on table "public"."email_messages" from "service_role";

revoke references on table "public"."email_messages" from "service_role";

revoke select on table "public"."email_messages" from "service_role";

revoke trigger on table "public"."email_messages" from "service_role";

revoke truncate on table "public"."email_messages" from "service_role";

revoke update on table "public"."email_messages" from "service_role";

revoke delete on table "public"."email_templates" from "anon";

revoke insert on table "public"."email_templates" from "anon";

revoke references on table "public"."email_templates" from "anon";

revoke select on table "public"."email_templates" from "anon";

revoke trigger on table "public"."email_templates" from "anon";

revoke truncate on table "public"."email_templates" from "anon";

revoke update on table "public"."email_templates" from "anon";

revoke delete on table "public"."email_templates" from "authenticated";

revoke insert on table "public"."email_templates" from "authenticated";

revoke references on table "public"."email_templates" from "authenticated";

revoke select on table "public"."email_templates" from "authenticated";

revoke trigger on table "public"."email_templates" from "authenticated";

revoke truncate on table "public"."email_templates" from "authenticated";

revoke update on table "public"."email_templates" from "authenticated";

revoke delete on table "public"."email_templates" from "service_role";

revoke insert on table "public"."email_templates" from "service_role";

revoke references on table "public"."email_templates" from "service_role";

revoke select on table "public"."email_templates" from "service_role";

revoke trigger on table "public"."email_templates" from "service_role";

revoke truncate on table "public"."email_templates" from "service_role";

revoke update on table "public"."email_templates" from "service_role";

revoke delete on table "public"."file_shares" from "anon";

revoke insert on table "public"."file_shares" from "anon";

revoke references on table "public"."file_shares" from "anon";

revoke select on table "public"."file_shares" from "anon";

revoke trigger on table "public"."file_shares" from "anon";

revoke truncate on table "public"."file_shares" from "anon";

revoke update on table "public"."file_shares" from "anon";

revoke delete on table "public"."file_shares" from "authenticated";

revoke insert on table "public"."file_shares" from "authenticated";

revoke references on table "public"."file_shares" from "authenticated";

revoke select on table "public"."file_shares" from "authenticated";

revoke trigger on table "public"."file_shares" from "authenticated";

revoke truncate on table "public"."file_shares" from "authenticated";

revoke update on table "public"."file_shares" from "authenticated";

revoke delete on table "public"."file_shares" from "service_role";

revoke insert on table "public"."file_shares" from "service_role";

revoke references on table "public"."file_shares" from "service_role";

revoke select on table "public"."file_shares" from "service_role";

revoke trigger on table "public"."file_shares" from "service_role";

revoke truncate on table "public"."file_shares" from "service_role";

revoke update on table "public"."file_shares" from "service_role";

revoke delete on table "public"."financial_categories" from "anon";

revoke insert on table "public"."financial_categories" from "anon";

revoke references on table "public"."financial_categories" from "anon";

revoke select on table "public"."financial_categories" from "anon";

revoke trigger on table "public"."financial_categories" from "anon";

revoke truncate on table "public"."financial_categories" from "anon";

revoke update on table "public"."financial_categories" from "anon";

revoke delete on table "public"."financial_categories" from "authenticated";

revoke insert on table "public"."financial_categories" from "authenticated";

revoke references on table "public"."financial_categories" from "authenticated";

revoke select on table "public"."financial_categories" from "authenticated";

revoke trigger on table "public"."financial_categories" from "authenticated";

revoke truncate on table "public"."financial_categories" from "authenticated";

revoke update on table "public"."financial_categories" from "authenticated";

revoke delete on table "public"."financial_categories" from "service_role";

revoke insert on table "public"."financial_categories" from "service_role";

revoke references on table "public"."financial_categories" from "service_role";

revoke select on table "public"."financial_categories" from "service_role";

revoke trigger on table "public"."financial_categories" from "service_role";

revoke truncate on table "public"."financial_categories" from "service_role";

revoke update on table "public"."financial_categories" from "service_role";

revoke delete on table "public"."integrations" from "anon";

revoke insert on table "public"."integrations" from "anon";

revoke references on table "public"."integrations" from "anon";

revoke select on table "public"."integrations" from "anon";

revoke trigger on table "public"."integrations" from "anon";

revoke truncate on table "public"."integrations" from "anon";

revoke update on table "public"."integrations" from "anon";

revoke delete on table "public"."integrations" from "authenticated";

revoke insert on table "public"."integrations" from "authenticated";

revoke references on table "public"."integrations" from "authenticated";

revoke select on table "public"."integrations" from "authenticated";

revoke trigger on table "public"."integrations" from "authenticated";

revoke truncate on table "public"."integrations" from "authenticated";

revoke update on table "public"."integrations" from "authenticated";

revoke delete on table "public"."integrations" from "service_role";

revoke insert on table "public"."integrations" from "service_role";

revoke references on table "public"."integrations" from "service_role";

revoke select on table "public"."integrations" from "service_role";

revoke trigger on table "public"."integrations" from "service_role";

revoke truncate on table "public"."integrations" from "service_role";

revoke update on table "public"."integrations" from "service_role";

revoke delete on table "public"."interactive_checklists" from "anon";

revoke insert on table "public"."interactive_checklists" from "anon";

revoke references on table "public"."interactive_checklists" from "anon";

revoke select on table "public"."interactive_checklists" from "anon";

revoke trigger on table "public"."interactive_checklists" from "anon";

revoke truncate on table "public"."interactive_checklists" from "anon";

revoke update on table "public"."interactive_checklists" from "anon";

revoke delete on table "public"."interactive_checklists" from "authenticated";

revoke insert on table "public"."interactive_checklists" from "authenticated";

revoke references on table "public"."interactive_checklists" from "authenticated";

revoke select on table "public"."interactive_checklists" from "authenticated";

revoke trigger on table "public"."interactive_checklists" from "authenticated";

revoke truncate on table "public"."interactive_checklists" from "authenticated";

revoke update on table "public"."interactive_checklists" from "authenticated";

revoke delete on table "public"."interactive_checklists" from "service_role";

revoke insert on table "public"."interactive_checklists" from "service_role";

revoke references on table "public"."interactive_checklists" from "service_role";

revoke select on table "public"."interactive_checklists" from "service_role";

revoke trigger on table "public"."interactive_checklists" from "service_role";

revoke truncate on table "public"."interactive_checklists" from "service_role";

revoke update on table "public"."interactive_checklists" from "service_role";

revoke delete on table "public"."invoices" from "anon";

revoke insert on table "public"."invoices" from "anon";

revoke references on table "public"."invoices" from "anon";

revoke select on table "public"."invoices" from "anon";

revoke trigger on table "public"."invoices" from "anon";

revoke truncate on table "public"."invoices" from "anon";

revoke update on table "public"."invoices" from "anon";

revoke delete on table "public"."invoices" from "authenticated";

revoke insert on table "public"."invoices" from "authenticated";

revoke references on table "public"."invoices" from "authenticated";

revoke select on table "public"."invoices" from "authenticated";

revoke trigger on table "public"."invoices" from "authenticated";

revoke truncate on table "public"."invoices" from "authenticated";

revoke update on table "public"."invoices" from "authenticated";

revoke delete on table "public"."invoices" from "service_role";

revoke insert on table "public"."invoices" from "service_role";

revoke references on table "public"."invoices" from "service_role";

revoke select on table "public"."invoices" from "service_role";

revoke trigger on table "public"."invoices" from "service_role";

revoke truncate on table "public"."invoices" from "service_role";

revoke update on table "public"."invoices" from "service_role";

revoke delete on table "public"."lead_interactions" from "anon";

revoke insert on table "public"."lead_interactions" from "anon";

revoke references on table "public"."lead_interactions" from "anon";

revoke select on table "public"."lead_interactions" from "anon";

revoke trigger on table "public"."lead_interactions" from "anon";

revoke truncate on table "public"."lead_interactions" from "anon";

revoke update on table "public"."lead_interactions" from "anon";

revoke delete on table "public"."lead_interactions" from "authenticated";

revoke insert on table "public"."lead_interactions" from "authenticated";

revoke references on table "public"."lead_interactions" from "authenticated";

revoke select on table "public"."lead_interactions" from "authenticated";

revoke trigger on table "public"."lead_interactions" from "authenticated";

revoke truncate on table "public"."lead_interactions" from "authenticated";

revoke update on table "public"."lead_interactions" from "authenticated";

revoke delete on table "public"."lead_interactions" from "service_role";

revoke insert on table "public"."lead_interactions" from "service_role";

revoke references on table "public"."lead_interactions" from "service_role";

revoke select on table "public"."lead_interactions" from "service_role";

revoke trigger on table "public"."lead_interactions" from "service_role";

revoke truncate on table "public"."lead_interactions" from "service_role";

revoke update on table "public"."lead_interactions" from "service_role";

revoke delete on table "public"."leads" from "anon";

revoke insert on table "public"."leads" from "anon";

revoke references on table "public"."leads" from "anon";

revoke select on table "public"."leads" from "anon";

revoke trigger on table "public"."leads" from "anon";

revoke truncate on table "public"."leads" from "anon";

revoke update on table "public"."leads" from "anon";

revoke delete on table "public"."leads" from "authenticated";

revoke insert on table "public"."leads" from "authenticated";

revoke references on table "public"."leads" from "authenticated";

revoke select on table "public"."leads" from "authenticated";

revoke trigger on table "public"."leads" from "authenticated";

revoke truncate on table "public"."leads" from "authenticated";

revoke update on table "public"."leads" from "authenticated";

revoke delete on table "public"."leads" from "service_role";

revoke insert on table "public"."leads" from "service_role";

revoke references on table "public"."leads" from "service_role";

revoke select on table "public"."leads" from "service_role";

revoke trigger on table "public"."leads" from "service_role";

revoke truncate on table "public"."leads" from "service_role";

revoke update on table "public"."leads" from "service_role";

revoke delete on table "public"."notification_queue" from "anon";

revoke insert on table "public"."notification_queue" from "anon";

revoke references on table "public"."notification_queue" from "anon";

revoke select on table "public"."notification_queue" from "anon";

revoke trigger on table "public"."notification_queue" from "anon";

revoke truncate on table "public"."notification_queue" from "anon";

revoke update on table "public"."notification_queue" from "anon";

revoke delete on table "public"."notification_queue" from "authenticated";

revoke insert on table "public"."notification_queue" from "authenticated";

revoke references on table "public"."notification_queue" from "authenticated";

revoke select on table "public"."notification_queue" from "authenticated";

revoke trigger on table "public"."notification_queue" from "authenticated";

revoke truncate on table "public"."notification_queue" from "authenticated";

revoke update on table "public"."notification_queue" from "authenticated";

revoke delete on table "public"."notification_queue" from "service_role";

revoke insert on table "public"."notification_queue" from "service_role";

revoke references on table "public"."notification_queue" from "service_role";

revoke select on table "public"."notification_queue" from "service_role";

revoke trigger on table "public"."notification_queue" from "service_role";

revoke truncate on table "public"."notification_queue" from "service_role";

revoke update on table "public"."notification_queue" from "service_role";

revoke delete on table "public"."payment_methods" from "anon";

revoke insert on table "public"."payment_methods" from "anon";

revoke references on table "public"."payment_methods" from "anon";

revoke select on table "public"."payment_methods" from "anon";

revoke trigger on table "public"."payment_methods" from "anon";

revoke truncate on table "public"."payment_methods" from "anon";

revoke update on table "public"."payment_methods" from "anon";

revoke delete on table "public"."payment_methods" from "authenticated";

revoke insert on table "public"."payment_methods" from "authenticated";

revoke references on table "public"."payment_methods" from "authenticated";

revoke select on table "public"."payment_methods" from "authenticated";

revoke trigger on table "public"."payment_methods" from "authenticated";

revoke truncate on table "public"."payment_methods" from "authenticated";

revoke update on table "public"."payment_methods" from "authenticated";

revoke delete on table "public"."payment_methods" from "service_role";

revoke insert on table "public"."payment_methods" from "service_role";

revoke references on table "public"."payment_methods" from "service_role";

revoke select on table "public"."payment_methods" from "service_role";

revoke trigger on table "public"."payment_methods" from "service_role";

revoke truncate on table "public"."payment_methods" from "service_role";

revoke update on table "public"."payment_methods" from "service_role";

revoke delete on table "public"."payment_transactions" from "anon";

revoke insert on table "public"."payment_transactions" from "anon";

revoke references on table "public"."payment_transactions" from "anon";

revoke select on table "public"."payment_transactions" from "anon";

revoke trigger on table "public"."payment_transactions" from "anon";

revoke truncate on table "public"."payment_transactions" from "anon";

revoke update on table "public"."payment_transactions" from "anon";

revoke delete on table "public"."payment_transactions" from "authenticated";

revoke insert on table "public"."payment_transactions" from "authenticated";

revoke references on table "public"."payment_transactions" from "authenticated";

revoke select on table "public"."payment_transactions" from "authenticated";

revoke trigger on table "public"."payment_transactions" from "authenticated";

revoke truncate on table "public"."payment_transactions" from "authenticated";

revoke update on table "public"."payment_transactions" from "authenticated";

revoke delete on table "public"."payment_transactions" from "service_role";

revoke insert on table "public"."payment_transactions" from "service_role";

revoke references on table "public"."payment_transactions" from "service_role";

revoke select on table "public"."payment_transactions" from "service_role";

revoke trigger on table "public"."payment_transactions" from "service_role";

revoke truncate on table "public"."payment_transactions" from "service_role";

revoke update on table "public"."payment_transactions" from "service_role";

revoke delete on table "public"."performance_metrics" from "anon";

revoke insert on table "public"."performance_metrics" from "anon";

revoke references on table "public"."performance_metrics" from "anon";

revoke select on table "public"."performance_metrics" from "anon";

revoke trigger on table "public"."performance_metrics" from "anon";

revoke truncate on table "public"."performance_metrics" from "anon";

revoke update on table "public"."performance_metrics" from "anon";

revoke delete on table "public"."performance_metrics" from "authenticated";

revoke insert on table "public"."performance_metrics" from "authenticated";

revoke references on table "public"."performance_metrics" from "authenticated";

revoke select on table "public"."performance_metrics" from "authenticated";

revoke trigger on table "public"."performance_metrics" from "authenticated";

revoke truncate on table "public"."performance_metrics" from "authenticated";

revoke update on table "public"."performance_metrics" from "authenticated";

revoke delete on table "public"."performance_metrics" from "service_role";

revoke insert on table "public"."performance_metrics" from "service_role";

revoke references on table "public"."performance_metrics" from "service_role";

revoke select on table "public"."performance_metrics" from "service_role";

revoke trigger on table "public"."performance_metrics" from "service_role";

revoke truncate on table "public"."performance_metrics" from "service_role";

revoke update on table "public"."performance_metrics" from "service_role";

revoke delete on table "public"."platform_settings" from "anon";

revoke insert on table "public"."platform_settings" from "anon";

revoke references on table "public"."platform_settings" from "anon";

revoke select on table "public"."platform_settings" from "anon";

revoke trigger on table "public"."platform_settings" from "anon";

revoke truncate on table "public"."platform_settings" from "anon";

revoke update on table "public"."platform_settings" from "anon";

revoke delete on table "public"."platform_settings" from "authenticated";

revoke insert on table "public"."platform_settings" from "authenticated";

revoke references on table "public"."platform_settings" from "authenticated";

revoke select on table "public"."platform_settings" from "authenticated";

revoke trigger on table "public"."platform_settings" from "authenticated";

revoke truncate on table "public"."platform_settings" from "authenticated";

revoke update on table "public"."platform_settings" from "authenticated";

revoke delete on table "public"."platform_settings" from "service_role";

revoke insert on table "public"."platform_settings" from "service_role";

revoke references on table "public"."platform_settings" from "service_role";

revoke select on table "public"."platform_settings" from "service_role";

revoke trigger on table "public"."platform_settings" from "service_role";

revoke truncate on table "public"."platform_settings" from "service_role";

revoke update on table "public"."platform_settings" from "service_role";

revoke delete on table "public"."playbooks" from "anon";

revoke insert on table "public"."playbooks" from "anon";

revoke references on table "public"."playbooks" from "anon";

revoke select on table "public"."playbooks" from "anon";

revoke trigger on table "public"."playbooks" from "anon";

revoke truncate on table "public"."playbooks" from "anon";

revoke update on table "public"."playbooks" from "anon";

revoke delete on table "public"."playbooks" from "authenticated";

revoke insert on table "public"."playbooks" from "authenticated";

revoke references on table "public"."playbooks" from "authenticated";

revoke select on table "public"."playbooks" from "authenticated";

revoke trigger on table "public"."playbooks" from "authenticated";

revoke truncate on table "public"."playbooks" from "authenticated";

revoke update on table "public"."playbooks" from "authenticated";

revoke delete on table "public"."playbooks" from "service_role";

revoke insert on table "public"."playbooks" from "service_role";

revoke references on table "public"."playbooks" from "service_role";

revoke select on table "public"."playbooks" from "service_role";

revoke trigger on table "public"."playbooks" from "service_role";

revoke truncate on table "public"."playbooks" from "service_role";

revoke update on table "public"."playbooks" from "service_role";

revoke delete on table "public"."presignups" from "anon";

revoke insert on table "public"."presignups" from "anon";

revoke references on table "public"."presignups" from "anon";

revoke select on table "public"."presignups" from "anon";

revoke trigger on table "public"."presignups" from "anon";

revoke truncate on table "public"."presignups" from "anon";

revoke update on table "public"."presignups" from "anon";

revoke delete on table "public"."presignups" from "authenticated";

revoke insert on table "public"."presignups" from "authenticated";

revoke references on table "public"."presignups" from "authenticated";

revoke select on table "public"."presignups" from "authenticated";

revoke trigger on table "public"."presignups" from "authenticated";

revoke truncate on table "public"."presignups" from "authenticated";

revoke update on table "public"."presignups" from "authenticated";

revoke delete on table "public"."presignups" from "service_role";

revoke insert on table "public"."presignups" from "service_role";

revoke references on table "public"."presignups" from "service_role";

revoke select on table "public"."presignups" from "service_role";

revoke trigger on table "public"."presignups" from "service_role";

revoke truncate on table "public"."presignups" from "service_role";

revoke update on table "public"."presignups" from "service_role";

revoke delete on table "public"."project_milestones" from "anon";

revoke insert on table "public"."project_milestones" from "anon";

revoke references on table "public"."project_milestones" from "anon";

revoke select on table "public"."project_milestones" from "anon";

revoke trigger on table "public"."project_milestones" from "anon";

revoke truncate on table "public"."project_milestones" from "anon";

revoke update on table "public"."project_milestones" from "anon";

revoke delete on table "public"."project_milestones" from "authenticated";

revoke insert on table "public"."project_milestones" from "authenticated";

revoke references on table "public"."project_milestones" from "authenticated";

revoke select on table "public"."project_milestones" from "authenticated";

revoke trigger on table "public"."project_milestones" from "authenticated";

revoke truncate on table "public"."project_milestones" from "authenticated";

revoke update on table "public"."project_milestones" from "authenticated";

revoke delete on table "public"."project_milestones" from "service_role";

revoke insert on table "public"."project_milestones" from "service_role";

revoke references on table "public"."project_milestones" from "service_role";

revoke select on table "public"."project_milestones" from "service_role";

revoke trigger on table "public"."project_milestones" from "service_role";

revoke truncate on table "public"."project_milestones" from "service_role";

revoke update on table "public"."project_milestones" from "service_role";

revoke delete on table "public"."projects" from "anon";

revoke insert on table "public"."projects" from "anon";

revoke references on table "public"."projects" from "anon";

revoke select on table "public"."projects" from "anon";

revoke trigger on table "public"."projects" from "anon";

revoke truncate on table "public"."projects" from "anon";

revoke update on table "public"."projects" from "anon";

revoke delete on table "public"."projects" from "authenticated";

revoke insert on table "public"."projects" from "authenticated";

revoke references on table "public"."projects" from "authenticated";

revoke select on table "public"."projects" from "authenticated";

revoke trigger on table "public"."projects" from "authenticated";

revoke truncate on table "public"."projects" from "authenticated";

revoke update on table "public"."projects" from "authenticated";

revoke delete on table "public"."projects" from "service_role";

revoke insert on table "public"."projects" from "service_role";

revoke references on table "public"."projects" from "service_role";

revoke select on table "public"."projects" from "service_role";

revoke trigger on table "public"."projects" from "service_role";

revoke truncate on table "public"."projects" from "service_role";

revoke update on table "public"."projects" from "service_role";

revoke delete on table "public"."proposals" from "anon";

revoke insert on table "public"."proposals" from "anon";

revoke references on table "public"."proposals" from "anon";

revoke select on table "public"."proposals" from "anon";

revoke trigger on table "public"."proposals" from "anon";

revoke truncate on table "public"."proposals" from "anon";

revoke update on table "public"."proposals" from "anon";

revoke delete on table "public"."proposals" from "authenticated";

revoke insert on table "public"."proposals" from "authenticated";

revoke references on table "public"."proposals" from "authenticated";

revoke select on table "public"."proposals" from "authenticated";

revoke trigger on table "public"."proposals" from "authenticated";

revoke truncate on table "public"."proposals" from "authenticated";

revoke update on table "public"."proposals" from "authenticated";

revoke delete on table "public"."proposals" from "service_role";

revoke insert on table "public"."proposals" from "service_role";

revoke references on table "public"."proposals" from "service_role";

revoke select on table "public"."proposals" from "service_role";

revoke trigger on table "public"."proposals" from "service_role";

revoke truncate on table "public"."proposals" from "service_role";

revoke update on table "public"."proposals" from "service_role";

revoke delete on table "public"."qualification_responses" from "anon";

revoke insert on table "public"."qualification_responses" from "anon";

revoke references on table "public"."qualification_responses" from "anon";

revoke select on table "public"."qualification_responses" from "anon";

revoke trigger on table "public"."qualification_responses" from "anon";

revoke truncate on table "public"."qualification_responses" from "anon";

revoke update on table "public"."qualification_responses" from "anon";

revoke delete on table "public"."qualification_responses" from "authenticated";

revoke insert on table "public"."qualification_responses" from "authenticated";

revoke references on table "public"."qualification_responses" from "authenticated";

revoke select on table "public"."qualification_responses" from "authenticated";

revoke trigger on table "public"."qualification_responses" from "authenticated";

revoke truncate on table "public"."qualification_responses" from "authenticated";

revoke update on table "public"."qualification_responses" from "authenticated";

revoke delete on table "public"."qualification_responses" from "service_role";

revoke insert on table "public"."qualification_responses" from "service_role";

revoke references on table "public"."qualification_responses" from "service_role";

revoke select on table "public"."qualification_responses" from "service_role";

revoke trigger on table "public"."qualification_responses" from "service_role";

revoke truncate on table "public"."qualification_responses" from "service_role";

revoke update on table "public"."qualification_responses" from "service_role";

revoke delete on table "public"."security_scans" from "anon";

revoke insert on table "public"."security_scans" from "anon";

revoke references on table "public"."security_scans" from "anon";

revoke select on table "public"."security_scans" from "anon";

revoke trigger on table "public"."security_scans" from "anon";

revoke truncate on table "public"."security_scans" from "anon";

revoke update on table "public"."security_scans" from "anon";

revoke delete on table "public"."security_scans" from "authenticated";

revoke insert on table "public"."security_scans" from "authenticated";

revoke references on table "public"."security_scans" from "authenticated";

revoke select on table "public"."security_scans" from "authenticated";

revoke trigger on table "public"."security_scans" from "authenticated";

revoke truncate on table "public"."security_scans" from "authenticated";

revoke update on table "public"."security_scans" from "authenticated";

revoke delete on table "public"."security_scans" from "service_role";

revoke insert on table "public"."security_scans" from "service_role";

revoke references on table "public"."security_scans" from "service_role";

revoke select on table "public"."security_scans" from "service_role";

revoke trigger on table "public"."security_scans" from "service_role";

revoke truncate on table "public"."security_scans" from "service_role";

revoke update on table "public"."security_scans" from "service_role";

revoke delete on table "public"."storage_items" from "anon";

revoke insert on table "public"."storage_items" from "anon";

revoke references on table "public"."storage_items" from "anon";

revoke select on table "public"."storage_items" from "anon";

revoke trigger on table "public"."storage_items" from "anon";

revoke truncate on table "public"."storage_items" from "anon";

revoke update on table "public"."storage_items" from "anon";

revoke delete on table "public"."storage_items" from "authenticated";

revoke insert on table "public"."storage_items" from "authenticated";

revoke references on table "public"."storage_items" from "authenticated";

revoke select on table "public"."storage_items" from "authenticated";

revoke trigger on table "public"."storage_items" from "authenticated";

revoke truncate on table "public"."storage_items" from "authenticated";

revoke update on table "public"."storage_items" from "authenticated";

revoke delete on table "public"."storage_items" from "service_role";

revoke insert on table "public"."storage_items" from "service_role";

revoke references on table "public"."storage_items" from "service_role";

revoke select on table "public"."storage_items" from "service_role";

revoke trigger on table "public"."storage_items" from "service_role";

revoke truncate on table "public"."storage_items" from "service_role";

revoke update on table "public"."storage_items" from "service_role";

revoke delete on table "public"."subscription_plans" from "anon";

revoke insert on table "public"."subscription_plans" from "anon";

revoke references on table "public"."subscription_plans" from "anon";

revoke select on table "public"."subscription_plans" from "anon";

revoke trigger on table "public"."subscription_plans" from "anon";

revoke truncate on table "public"."subscription_plans" from "anon";

revoke update on table "public"."subscription_plans" from "anon";

revoke delete on table "public"."subscription_plans" from "authenticated";

revoke insert on table "public"."subscription_plans" from "authenticated";

revoke references on table "public"."subscription_plans" from "authenticated";

revoke select on table "public"."subscription_plans" from "authenticated";

revoke trigger on table "public"."subscription_plans" from "authenticated";

revoke truncate on table "public"."subscription_plans" from "authenticated";

revoke update on table "public"."subscription_plans" from "authenticated";

revoke delete on table "public"."subscription_plans" from "service_role";

revoke insert on table "public"."subscription_plans" from "service_role";

revoke references on table "public"."subscription_plans" from "service_role";

revoke select on table "public"."subscription_plans" from "service_role";

revoke trigger on table "public"."subscription_plans" from "service_role";

revoke truncate on table "public"."subscription_plans" from "service_role";

revoke update on table "public"."subscription_plans" from "service_role";

revoke delete on table "public"."subscriptions" from "anon";

revoke insert on table "public"."subscriptions" from "anon";

revoke references on table "public"."subscriptions" from "anon";

revoke select on table "public"."subscriptions" from "anon";

revoke trigger on table "public"."subscriptions" from "anon";

revoke truncate on table "public"."subscriptions" from "anon";

revoke update on table "public"."subscriptions" from "anon";

revoke delete on table "public"."subscriptions" from "authenticated";

revoke insert on table "public"."subscriptions" from "authenticated";

revoke references on table "public"."subscriptions" from "authenticated";

revoke select on table "public"."subscriptions" from "authenticated";

revoke trigger on table "public"."subscriptions" from "authenticated";

revoke truncate on table "public"."subscriptions" from "authenticated";

revoke update on table "public"."subscriptions" from "authenticated";

revoke delete on table "public"."subscriptions" from "service_role";

revoke insert on table "public"."subscriptions" from "service_role";

revoke references on table "public"."subscriptions" from "service_role";

revoke select on table "public"."subscriptions" from "service_role";

revoke trigger on table "public"."subscriptions" from "service_role";

revoke truncate on table "public"."subscriptions" from "service_role";

revoke update on table "public"."subscriptions" from "service_role";

revoke delete on table "public"."support_ticket_messages" from "anon";

revoke insert on table "public"."support_ticket_messages" from "anon";

revoke references on table "public"."support_ticket_messages" from "anon";

revoke select on table "public"."support_ticket_messages" from "anon";

revoke trigger on table "public"."support_ticket_messages" from "anon";

revoke truncate on table "public"."support_ticket_messages" from "anon";

revoke update on table "public"."support_ticket_messages" from "anon";

revoke delete on table "public"."support_ticket_messages" from "authenticated";

revoke insert on table "public"."support_ticket_messages" from "authenticated";

revoke references on table "public"."support_ticket_messages" from "authenticated";

revoke select on table "public"."support_ticket_messages" from "authenticated";

revoke trigger on table "public"."support_ticket_messages" from "authenticated";

revoke truncate on table "public"."support_ticket_messages" from "authenticated";

revoke update on table "public"."support_ticket_messages" from "authenticated";

revoke delete on table "public"."support_ticket_messages" from "service_role";

revoke insert on table "public"."support_ticket_messages" from "service_role";

revoke references on table "public"."support_ticket_messages" from "service_role";

revoke select on table "public"."support_ticket_messages" from "service_role";

revoke trigger on table "public"."support_ticket_messages" from "service_role";

revoke truncate on table "public"."support_ticket_messages" from "service_role";

revoke update on table "public"."support_ticket_messages" from "service_role";

revoke delete on table "public"."support_tickets" from "anon";

revoke insert on table "public"."support_tickets" from "anon";

revoke references on table "public"."support_tickets" from "anon";

revoke select on table "public"."support_tickets" from "anon";

revoke trigger on table "public"."support_tickets" from "anon";

revoke truncate on table "public"."support_tickets" from "anon";

revoke update on table "public"."support_tickets" from "anon";

revoke delete on table "public"."support_tickets" from "authenticated";

revoke insert on table "public"."support_tickets" from "authenticated";

revoke references on table "public"."support_tickets" from "authenticated";

revoke select on table "public"."support_tickets" from "authenticated";

revoke trigger on table "public"."support_tickets" from "authenticated";

revoke truncate on table "public"."support_tickets" from "authenticated";

revoke update on table "public"."support_tickets" from "authenticated";

revoke delete on table "public"."support_tickets" from "service_role";

revoke insert on table "public"."support_tickets" from "service_role";

revoke references on table "public"."support_tickets" from "service_role";

revoke select on table "public"."support_tickets" from "service_role";

revoke trigger on table "public"."support_tickets" from "service_role";

revoke truncate on table "public"."support_tickets" from "service_role";

revoke update on table "public"."support_tickets" from "service_role";

revoke delete on table "public"."tasks" from "anon";

revoke insert on table "public"."tasks" from "anon";

revoke references on table "public"."tasks" from "anon";

revoke select on table "public"."tasks" from "anon";

revoke trigger on table "public"."tasks" from "anon";

revoke truncate on table "public"."tasks" from "anon";

revoke update on table "public"."tasks" from "anon";

revoke delete on table "public"."tasks" from "authenticated";

revoke insert on table "public"."tasks" from "authenticated";

revoke references on table "public"."tasks" from "authenticated";

revoke select on table "public"."tasks" from "authenticated";

revoke trigger on table "public"."tasks" from "authenticated";

revoke truncate on table "public"."tasks" from "authenticated";

revoke update on table "public"."tasks" from "authenticated";

revoke delete on table "public"."tasks" from "service_role";

revoke insert on table "public"."tasks" from "service_role";

revoke references on table "public"."tasks" from "service_role";

revoke select on table "public"."tasks" from "service_role";

revoke trigger on table "public"."tasks" from "service_role";

revoke truncate on table "public"."tasks" from "service_role";

revoke update on table "public"."tasks" from "service_role";

revoke delete on table "public"."team_members" from "anon";

revoke insert on table "public"."team_members" from "anon";

revoke references on table "public"."team_members" from "anon";

revoke select on table "public"."team_members" from "anon";

revoke trigger on table "public"."team_members" from "anon";

revoke truncate on table "public"."team_members" from "anon";

revoke update on table "public"."team_members" from "anon";

revoke delete on table "public"."team_members" from "authenticated";

revoke insert on table "public"."team_members" from "authenticated";

revoke references on table "public"."team_members" from "authenticated";

revoke select on table "public"."team_members" from "authenticated";

revoke trigger on table "public"."team_members" from "authenticated";

revoke truncate on table "public"."team_members" from "authenticated";

revoke update on table "public"."team_members" from "authenticated";

revoke delete on table "public"."team_members" from "service_role";

revoke insert on table "public"."team_members" from "service_role";

revoke references on table "public"."team_members" from "service_role";

revoke select on table "public"."team_members" from "service_role";

revoke trigger on table "public"."team_members" from "service_role";

revoke truncate on table "public"."team_members" from "service_role";

revoke update on table "public"."team_members" from "service_role";

revoke delete on table "public"."transactions" from "anon";

revoke insert on table "public"."transactions" from "anon";

revoke references on table "public"."transactions" from "anon";

revoke select on table "public"."transactions" from "anon";

revoke trigger on table "public"."transactions" from "anon";

revoke truncate on table "public"."transactions" from "anon";

revoke update on table "public"."transactions" from "anon";

revoke delete on table "public"."transactions" from "authenticated";

revoke insert on table "public"."transactions" from "authenticated";

revoke references on table "public"."transactions" from "authenticated";

revoke select on table "public"."transactions" from "authenticated";

revoke trigger on table "public"."transactions" from "authenticated";

revoke truncate on table "public"."transactions" from "authenticated";

revoke update on table "public"."transactions" from "authenticated";

revoke delete on table "public"."transactions" from "service_role";

revoke insert on table "public"."transactions" from "service_role";

revoke references on table "public"."transactions" from "service_role";

revoke select on table "public"."transactions" from "service_role";

revoke trigger on table "public"."transactions" from "service_role";

revoke truncate on table "public"."transactions" from "service_role";

revoke update on table "public"."transactions" from "service_role";

revoke delete on table "public"."uptime_checks" from "anon";

revoke insert on table "public"."uptime_checks" from "anon";

revoke references on table "public"."uptime_checks" from "anon";

revoke select on table "public"."uptime_checks" from "anon";

revoke trigger on table "public"."uptime_checks" from "anon";

revoke truncate on table "public"."uptime_checks" from "anon";

revoke update on table "public"."uptime_checks" from "anon";

revoke delete on table "public"."uptime_checks" from "authenticated";

revoke insert on table "public"."uptime_checks" from "authenticated";

revoke references on table "public"."uptime_checks" from "authenticated";

revoke select on table "public"."uptime_checks" from "authenticated";

revoke trigger on table "public"."uptime_checks" from "authenticated";

revoke truncate on table "public"."uptime_checks" from "authenticated";

revoke update on table "public"."uptime_checks" from "authenticated";

revoke delete on table "public"."uptime_checks" from "service_role";

revoke insert on table "public"."uptime_checks" from "service_role";

revoke references on table "public"."uptime_checks" from "service_role";

revoke select on table "public"."uptime_checks" from "service_role";

revoke trigger on table "public"."uptime_checks" from "service_role";

revoke truncate on table "public"."uptime_checks" from "service_role";

revoke update on table "public"."uptime_checks" from "service_role";

revoke delete on table "public"."user_profiles" from "anon";

revoke insert on table "public"."user_profiles" from "anon";

revoke references on table "public"."user_profiles" from "anon";

revoke select on table "public"."user_profiles" from "anon";

revoke trigger on table "public"."user_profiles" from "anon";

revoke truncate on table "public"."user_profiles" from "anon";

revoke update on table "public"."user_profiles" from "anon";

revoke delete on table "public"."user_profiles" from "authenticated";

revoke insert on table "public"."user_profiles" from "authenticated";

revoke references on table "public"."user_profiles" from "authenticated";

revoke select on table "public"."user_profiles" from "authenticated";

revoke trigger on table "public"."user_profiles" from "authenticated";

revoke truncate on table "public"."user_profiles" from "authenticated";

revoke update on table "public"."user_profiles" from "authenticated";

revoke delete on table "public"."user_profiles" from "service_role";

revoke insert on table "public"."user_profiles" from "service_role";

revoke references on table "public"."user_profiles" from "service_role";

revoke select on table "public"."user_profiles" from "service_role";

revoke trigger on table "public"."user_profiles" from "service_role";

revoke truncate on table "public"."user_profiles" from "service_role";

revoke update on table "public"."user_profiles" from "service_role";

revoke delete on table "public"."webhook_events" from "anon";

revoke insert on table "public"."webhook_events" from "anon";

revoke references on table "public"."webhook_events" from "anon";

revoke select on table "public"."webhook_events" from "anon";

revoke trigger on table "public"."webhook_events" from "anon";

revoke truncate on table "public"."webhook_events" from "anon";

revoke update on table "public"."webhook_events" from "anon";

revoke delete on table "public"."webhook_events" from "authenticated";

revoke insert on table "public"."webhook_events" from "authenticated";

revoke references on table "public"."webhook_events" from "authenticated";

revoke select on table "public"."webhook_events" from "authenticated";

revoke trigger on table "public"."webhook_events" from "authenticated";

revoke truncate on table "public"."webhook_events" from "authenticated";

revoke update on table "public"."webhook_events" from "authenticated";

revoke delete on table "public"."webhook_events" from "service_role";

revoke insert on table "public"."webhook_events" from "service_role";

revoke references on table "public"."webhook_events" from "service_role";

revoke select on table "public"."webhook_events" from "service_role";

revoke trigger on table "public"."webhook_events" from "service_role";

revoke truncate on table "public"."webhook_events" from "service_role";

revoke update on table "public"."webhook_events" from "service_role";

revoke delete on table "public"."whatsapp_contacts" from "anon";

revoke insert on table "public"."whatsapp_contacts" from "anon";

revoke references on table "public"."whatsapp_contacts" from "anon";

revoke select on table "public"."whatsapp_contacts" from "anon";

revoke trigger on table "public"."whatsapp_contacts" from "anon";

revoke truncate on table "public"."whatsapp_contacts" from "anon";

revoke update on table "public"."whatsapp_contacts" from "anon";

revoke delete on table "public"."whatsapp_contacts" from "authenticated";

revoke insert on table "public"."whatsapp_contacts" from "authenticated";

revoke references on table "public"."whatsapp_contacts" from "authenticated";

revoke select on table "public"."whatsapp_contacts" from "authenticated";

revoke trigger on table "public"."whatsapp_contacts" from "authenticated";

revoke truncate on table "public"."whatsapp_contacts" from "authenticated";

revoke update on table "public"."whatsapp_contacts" from "authenticated";

revoke delete on table "public"."whatsapp_contacts" from "service_role";

revoke insert on table "public"."whatsapp_contacts" from "service_role";

revoke references on table "public"."whatsapp_contacts" from "service_role";

revoke select on table "public"."whatsapp_contacts" from "service_role";

revoke trigger on table "public"."whatsapp_contacts" from "service_role";

revoke truncate on table "public"."whatsapp_contacts" from "service_role";

revoke update on table "public"."whatsapp_contacts" from "service_role";

revoke delete on table "public"."whatsapp_messages" from "anon";

revoke insert on table "public"."whatsapp_messages" from "anon";

revoke references on table "public"."whatsapp_messages" from "anon";

revoke select on table "public"."whatsapp_messages" from "anon";

revoke trigger on table "public"."whatsapp_messages" from "anon";

revoke truncate on table "public"."whatsapp_messages" from "anon";

revoke update on table "public"."whatsapp_messages" from "anon";

revoke delete on table "public"."whatsapp_messages" from "authenticated";

revoke insert on table "public"."whatsapp_messages" from "authenticated";

revoke references on table "public"."whatsapp_messages" from "authenticated";

revoke select on table "public"."whatsapp_messages" from "authenticated";

revoke trigger on table "public"."whatsapp_messages" from "authenticated";

revoke truncate on table "public"."whatsapp_messages" from "authenticated";

revoke update on table "public"."whatsapp_messages" from "authenticated";

revoke delete on table "public"."whatsapp_messages" from "service_role";

revoke insert on table "public"."whatsapp_messages" from "service_role";

revoke references on table "public"."whatsapp_messages" from "service_role";

revoke select on table "public"."whatsapp_messages" from "service_role";

revoke trigger on table "public"."whatsapp_messages" from "service_role";

revoke truncate on table "public"."whatsapp_messages" from "service_role";

revoke update on table "public"."whatsapp_messages" from "service_role";

drop function if exists "public"."archive_old_analyses"();

drop function if exists "public"."cleanup_old_audit_logs_v2"();

drop function if exists "public"."reset_monthly_limits"();

create table "public"."app_settings" (
    "key" text not null,
    "value" text not null,
    "updated_at" timestamp with time zone default now()
);


alter table "public"."payment_methods" alter column "id" set default gen_random_uuid();

alter table "public"."payment_transactions" alter column "id" set default gen_random_uuid();

alter table "public"."presignups" alter column "id" set default gen_random_uuid();

alter table "public"."subscription_plans" alter column "id" set default gen_random_uuid();

alter table "public"."subscriptions" alter column "id" set default gen_random_uuid();

alter table "public"."webhook_events" alter column "id" set default gen_random_uuid();

CREATE UNIQUE INDEX app_settings_pkey ON public.app_settings USING btree (key);

alter table "public"."app_settings" add constraint "app_settings_pkey" PRIMARY KEY using index "app_settings_pkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.get_app_setting(setting_key text)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  setting_value TEXT;
BEGIN
  SELECT value INTO setting_value
  FROM app_settings
  WHERE key = setting_key;
  
  RETURN setting_value;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.activate_subscription(p_subscription_id uuid, p_payment_id text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_row_count INTEGER;
BEGIN
  -- Atualizar status da subscription
  UPDATE public.subscriptions
  SET 
    status = 'active',
    updated_at = NOW()
  WHERE id = p_subscription_id
    AND status IN ('incomplete', 'past_due');
  
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  
  IF v_row_count > 0 THEN
    -- Log: subscription ativada
    RAISE NOTICE 'Subscription % activated with payment %', p_subscription_id, p_payment_id;
    RETURN TRUE;
  END IF;
  
  RETURN FALSE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.audit_changes()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    user_email TEXT;
    user_role TEXT;
    changed_fields TEXT[];
    old_json JSONB;
    new_json JSONB;
BEGIN
    -- Buscar email e role do usurio
    SELECT email INTO user_email FROM auth.users WHERE id = auth.uid();
    SELECT (auth.jwt() ->> 'role')::text INTO user_role;
    
    -- DELETE
    IF TG_OP = 'DELETE' THEN
        old_json := row_to_json(OLD)::jsonb;
        
        INSERT INTO public.audit_log (
            user_id, 
            user_email, 
            user_role,
            action, 
            table_name, 
            record_id, 
            old_data
        )
        VALUES (
            auth.uid(), 
            user_email,
            user_role,
            'DELETE', 
            TG_TABLE_NAME, 
            OLD.id, 
            old_json
        );
        
        RETURN OLD;
    
    -- UPDATE
    ELSIF TG_OP = 'UPDATE' THEN
        old_json := row_to_json(OLD)::jsonb;
        new_json := row_to_json(NEW)::jsonb;
        
        -- Detectar quais campos mudaram
        SELECT ARRAY_AGG(key) INTO changed_fields
        FROM jsonb_each(old_json)
        WHERE old_json->key IS DISTINCT FROM new_json->key;
        
        -- S registra se houver mudanas reais
        IF array_length(changed_fields, 1) > 0 THEN
            INSERT INTO public.audit_log (
                user_id, 
                user_email,
                user_role,
                action, 
                table_name, 
                record_id, 
                old_data, 
                new_data,
                changed_fields
            )
            VALUES (
                auth.uid(), 
                user_email,
                user_role,
                'UPDATE', 
                TG_TABLE_NAME, 
                NEW.id, 
                old_json, 
                new_json,
                changed_fields
            );
        END IF;
        
        RETURN NEW;
    
    -- INSERT
    ELSIF TG_OP = 'INSERT' THEN
        new_json := row_to_json(NEW)::jsonb;
        
        INSERT INTO public.audit_log (
            user_id, 
            user_email,
            user_role,
            action, 
            table_name, 
            record_id, 
            new_data
        )
        VALUES (
            auth.uid(), 
            user_email,
            user_role,
            'INSERT', 
            TG_TABLE_NAME, 
            NEW.id, 
            new_json
        );
        
        RETURN NEW;
    END IF;
    
    RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.auto_assign_lead()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  assigned_admin UUID;
BEGIN
  -- If lead already assigned, skip
  IF NEW.assigned_to IS NOT NULL THEN
    RETURN NEW;
  END IF;

  -- Find admin with least leads (round-robin assignment)
  SELECT up.id INTO assigned_admin
  FROM user_profiles up
  WHERE up.user_type = 'admin'
  ORDER BY (
    SELECT COUNT(*)
    FROM leads l
    WHERE l.assigned_to = up.id
  ) ASC
  LIMIT 1;

  -- If admin found, assign lead
  IF assigned_admin IS NOT NULL THEN
    NEW.assigned_to := assigned_admin;
    RAISE NOTICE 'Lead % auto-assigned to admin %', NEW.id, assigned_admin;
  END IF;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.auto_create_calendar_event()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NEW.booking_status = 'confirmed' AND NEW.calendar_event_id IS NULL THEN
    INSERT INTO calendar_events (
      user_id,
      title,
      description,
      event_type,
      start_date,
      start_time,
      duration_minutes,
      timezone,
      status,
      meeting_url,
      metadata
    )
    SELECT 
      NEW.user_id,
      ct.name || ' - ' || NEW.participant_name,
      ct.description,
      'consultoria',
      NEW.scheduled_date,
      NEW.scheduled_time,
      NEW.duration_minutes,
      NEW.timezone,
      'confirmed',
      NEW.meeting_url,
      jsonb_build_object(
        'booking_id', NEW.id,
        'consultoria_type', ct.name,
        'participant_email', NEW.participant_email,
        'amount_cents', NEW.final_amount_cents
      )
    FROM consultoria_types ct
    WHERE ct.id = NEW.consultoria_type_id
    RETURNING id INTO NEW.calendar_event_id;
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.auto_create_commission()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  commission_rate DECIMAL := 0.10; -- 10% commission
  commission_amount DECIMAL;
  agent_id UUID;
BEGIN
  -- Only process when status changes to 'paid'
  IF NEW.status = 'paid' AND (OLD.status IS NULL OR OLD.status != 'paid') THEN

    -- Calculate commission (10% of total_amount)
    commission_amount := NEW.total_amount * commission_rate;

    -- Find agent/consultant responsible (from user who created invoice)
    -- In future: get from invoice.assigned_to or client.assigned_to
    agent_id := NEW.user_id;

    -- Create commission record
    INSERT INTO commissions (
      user_id,
      invoice_id,
      amount,
      rate,
      status,
      created_at
    ) VALUES (
      agent_id,
      NEW.id,
      commission_amount,
      commission_rate,
      'pending',
      NOW()
    );

    RAISE NOTICE 'Commission created: R$ % for user %', commission_amount, agent_id;
  END IF;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.auto_schedule_reminders()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
  reminder_24h TIMESTAMPTZ;
  reminder_1h TIMESTAMPTZ;
BEGIN
  IF NEW.booking_status = 'confirmed' THEN
    reminder_24h := (NEW.scheduled_date || ' ' || NEW.scheduled_time)::TIMESTAMPTZ - INTERVAL '24 hours';
    reminder_1h := (NEW.scheduled_date || ' ' || NEW.scheduled_time)::TIMESTAMPTZ - INTERVAL '1 hour';
    
    INSERT INTO notification_queue (
      user_id,
      type,
      recipient,
      subject,
      body,
      scheduled_for,
      priority,
      metadata
    ) VALUES
    (
      NEW.user_id,
      'email',
      NEW.participant_email,
      'Lembrete: Consultoria em 24 horas',
      'Sua consultoria est agendada para amanh s ' || NEW.scheduled_time::TEXT,
      reminder_24h,
      8,
      jsonb_build_object('booking_id', NEW.id, 'reminder_type', '24h')
    ),
    (
      NEW.user_id,
      'email',
      NEW.participant_email,
      'Lembrete: Consultoria em 1 hora',
      'Sua consultoria comear em 1 hora. Link: ' || COALESCE(NEW.meeting_url, 'A definir'),
      reminder_1h,
      9,
      jsonb_build_object('booking_id', NEW.id, 'reminder_type', '1h')
    );
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.auto_update_invoice_status()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Auto-mark as overdue if past due date
    UPDATE public.invoices
    SET status = 'overdue'
    WHERE status = 'pending'
    AND due_date < NOW()
    AND user_id = NEW.user_id;
    
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.calculate_mrr()
 RETURNS numeric
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  total_mrr DECIMAL;
BEGIN
  SELECT COALESCE(SUM(
    CASE 
      WHEN sp.price_monthly IS NOT NULL THEN sp.price_monthly
      WHEN sp.price_yearly IS NOT NULL THEN sp.price_yearly / 12
      ELSE 0
    END
  ), 0)
  INTO total_mrr
  FROM public.subscriptions s
  JOIN public.subscription_plans sp ON s.plan_id = sp.id
  WHERE s.status = 'active';
  
  RETURN total_mrr;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.calculate_revenue_metrics(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now())
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_total_revenue DECIMAL;
  v_successful_payments INTEGER;
  v_failed_payments INTEGER;
  v_pending_payments INTEGER;
  v_mrr DECIMAL;
  v_active_subscriptions INTEGER;
BEGIN
  -- Total revenue (succeeded)
  SELECT COALESCE(SUM(amount), 0), COUNT(*)
  INTO v_total_revenue, v_successful_payments
  FROM public.payment_transactions
  WHERE status = 'succeeded'
    AND paid_at >= p_start_date
    AND paid_at <= p_end_date;
  
  -- Failed payments
  SELECT COUNT(*)
  INTO v_failed_payments
  FROM public.payment_transactions
  WHERE status = 'failed'
    AND created_at >= p_start_date
    AND created_at <= p_end_date;
  
  -- Pending payments
  SELECT COUNT(*)
  INTO v_pending_payments
  FROM public.payment_transactions
  WHERE status = 'pending'
    AND created_at >= p_start_date
    AND created_at <= p_end_date;
  
  -- MRR (Monthly Recurring Revenue)
  SELECT public.calculate_mrr() INTO v_mrr;
  
  -- Active subscriptions
  SELECT COUNT(*)
  INTO v_active_subscriptions
  FROM public.subscriptions
  WHERE status = 'active';
  
  RETURN jsonb_build_object(
    'period', jsonb_build_object(
      'start', p_start_date,
      'end', p_end_date
    ),
    'revenue', jsonb_build_object(
      'total', v_total_revenue,
      'mrr', v_mrr
    ),
    'payments', jsonb_build_object(
      'successful', v_successful_payments,
      'failed', v_failed_payments,
      'pending', v_pending_payments
    ),
    'subscriptions', jsonb_build_object(
      'active', v_active_subscriptions
    )
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cancel_subscription(p_subscription_id uuid, p_cancel_at_period_end boolean DEFAULT false)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_row_count INTEGER;
BEGIN
  IF p_cancel_at_period_end THEN
    -- Cancelar no final do perodo
    UPDATE public.subscriptions
    SET 
      cancel_at_period_end = TRUE,
      updated_at = NOW()
    WHERE id = p_subscription_id;
  ELSE
    -- Cancelar imediatamente
    UPDATE public.subscriptions
    SET 
      status = 'cancelled',
      cancelled_at = NOW(),
      updated_at = NOW()
    WHERE id = p_subscription_id;
  END IF;
  
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  
  RETURN (v_row_count > 0);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_domain_health()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  target_url TEXT;
BEGIN
  -- Check domain health for URLs from paid users' analyses
  FOR target_url IN
    SELECT DISTINCT ar.url
    FROM analysis_requests ar
    JOIN user_profiles up ON ar.user_id = up.id
    WHERE up.tier IN ('paid', 'admin')
  LOOP
    -- Upsert placeholder check (real implementation would call Edge Function)
    INSERT INTO domain_monitoring (url, ssl_valid, ssl_expires_at, dns_records, blacklist_status, last_checked)
    VALUES (target_url, true, now() + interval '90 days', '{}'::JSONB, 'clean', now())
    ON CONFLICT (url) DO UPDATE SET last_checked = now();
    
  END LOOP;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_security()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  target_url TEXT;
BEGIN
  -- Check security for URLs from paid users' analyses
  FOR target_url IN
    SELECT DISTINCT ar.url
    FROM analysis_requests ar
    JOIN user_profiles up ON ar.user_id = up.id
    WHERE up.tier IN ('paid', 'admin')
  LOOP
    -- Insert placeholder scan (real implementation would call Edge Function)
    INSERT INTO security_scans (url, scan_type, status, scanned_at)
    VALUES (target_url, 'ssl_headers', 'pending', now());
    
  END LOOP;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_uptime()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  target_url TEXT;
  http_resp RECORD;
  start_ts TIMESTAMPTZ;
  duration_ms INT;
BEGIN
  -- Check uptime for URLs from paid users' analyses
  FOR target_url IN
    SELECT DISTINCT ar.url
    FROM analysis_requests ar
    JOIN user_profiles up ON ar.user_id = up.id
    WHERE up.tier IN ('paid', 'admin')
  LOOP
    start_ts := clock_timestamp();
    
    -- Make HTTP request
    SELECT * INTO http_resp
    FROM net.http_get(
      url := target_url,
      timeout_milliseconds := 10000
    );
    
    duration_ms := EXTRACT(MILLISECOND FROM (clock_timestamp() - start_ts));
    
    -- Save result
    INSERT INTO uptime_checks (url, is_up, response_time_ms, status_code, checked_at)
    VALUES (
      target_url,
      (http_resp.status_code BETWEEN 200 AND 399),
      duration_ms,
      http_resp.status_code,
      now()
    );
      
  END LOOP;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_expired_domain_validations()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  DELETE FROM public.domain_validations
  WHERE cached_until < NOW();
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_expired_presignups()
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM public.presignups
  WHERE expires_at < NOW()
  AND NOT converted
  AND created_at < NOW() - INTERVAL '30 days';
  
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_expired_shares()
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_deleted integer;
BEGIN
  DELETE FROM public.file_shares
  WHERE expires_at IS NOT NULL
    AND expires_at < now();
  
  GET DIAGNOSTICS v_deleted = ROW_COUNT;
  RETURN v_deleted;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_old_audit_logs(days_to_keep integer DEFAULT 90)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    deleted_count INT;
BEGIN
    -- Deletar logs mais antigos que X dias
    DELETE FROM public.audit_log
    WHERE created_at < NOW() - (days_to_keep || ' days')::INTERVAL;
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    
    RETURN deleted_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_old_webhook_events()
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM public.webhook_events
  WHERE processed = TRUE
    AND created_at < NOW() - INTERVAL '7 days';
  
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  
  RETURN deleted_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.column_exists(table_name text, column_name text)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 
    FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND information_schema.columns.table_name = column_exists.table_name
      AND information_schema.columns.column_name = column_exists.column_name
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.create_client_profile(p_client_id uuid, p_data jsonb DEFAULT '{}'::jsonb)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    v_profile_id UUID;
BEGIN
    INSERT INTO public.client_profiles (
        client_id,
        business_type,
        industry,
        company_size,
        primary_contact_name,
        primary_contact_email,
        current_website,
        platform,
        primary_goals,
        pain_points,
        budget_range,
        design_style,
        preferred_communication,
        tags,
        notes,
        custom_data
    ) VALUES (
        p_client_id,
        COALESCE(p_data->>'business_type', 'corporate'),
        COALESCE(p_data->>'industry', 'other'),
        COALESCE(p_data->>'company_size', 'medium'),
        p_data->>'primary_contact_name',
        p_data->>'primary_contact_email',
        p_data->>'current_website',
        COALESCE(p_data->>'platform', 'custom'),
        COALESCE(
            ARRAY(SELECT jsonb_array_elements_text(p_data->'primary_goals')),
            ARRAY['improve_performance', 'increase_traffic']
        ),
        COALESCE(
            ARRAY(SELECT jsonb_array_elements_text(p_data->'pain_points')),
            ARRAY['slow_website', 'low_conversion']
        ),
        COALESCE(p_data->>'budget_range', 'not_disclosed'),
        COALESCE(p_data->>'design_style', 'modern'),
        COALESCE(p_data->>'preferred_communication', 'email'),
        COALESCE(
            ARRAY(SELECT jsonb_array_elements_text(p_data->'tags')),
            ARRAY[]::TEXT[]
        ),
        p_data->>'notes',
        COALESCE(p_data->'custom_data', '{}'::jsonb)
    ) RETURNING id INTO v_profile_id;
    
    -- Criar interao inicial
    INSERT INTO public.client_interactions (
        client_id,
        user_id,
        interaction_type,
        subject,
        description,
        metadata
    ) VALUES (
        p_client_id,
        auth.uid(),
        'profile_created',
        'Perfil do cliente criado',
        'Perfil completo criado no sistema',
        jsonb_build_object('profile_id', v_profile_id)
    );
    
    RETURN v_profile_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.create_personalized_checklist(p_client_id uuid, p_title text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    v_profile public.client_profiles%ROWTYPE;
    v_template public.checklist_templates%ROWTYPE;
    v_checklist_id UUID;
    v_client_name TEXT;
BEGIN
    -- Buscar perfil do cliente
    SELECT * INTO v_profile
    FROM public.client_profiles
    WHERE client_id = p_client_id;
    
    -- Buscar nome do cliente
    SELECT name INTO v_client_name
    FROM public.clients
    WHERE id = p_client_id;
    
    -- Buscar template adequado
    SELECT * INTO v_template
    FROM public.checklist_templates
    WHERE business_type = v_profile.business_type
    AND is_active = TRUE
    ORDER BY success_rate DESC, usage_count DESC
    LIMIT 1;
    
    -- Se no encontrar, usar template genrico
    IF v_template.id IS NULL THEN
        SELECT * INTO v_template
        FROM public.checklist_templates
        WHERE business_type IS NULL
        AND is_active = TRUE
        ORDER BY success_rate DESC
        LIMIT 1;
    END IF;
    
    -- Criar checklist
    INSERT INTO public.interactive_checklists (
        title,
        description,
        user_id,
        checklist_type,
        estimated_time_minutes,
        tags
    ) VALUES (
        COALESCE(p_title, 'Auditoria para ' || v_client_name),
        'Checklist personalizado baseado no perfil do cliente',
        auth.uid(),
        'website_audit',
        COALESCE(v_template.estimated_hours * 60, 480),
        ARRAY[v_profile.business_type, v_profile.industry]
    ) RETURNING id INTO v_checklist_id;
    
    -- Criar relacionamento
    INSERT INTO public.checklist_relationships (
        checklist_id,
        client_profile_id,
        relationship_type
    ) VALUES (
        v_checklist_id,
        v_profile.id,
        'client_audit'
    );
    
    -- Criar itens baseados no template (se existir)
    IF v_template.id IS NOT NULL THEN
        INSERT INTO public.checklist_items (
            checklist_id,
            category,
            title,
            description,
            priority,
            estimated_minutes,
            sort_order
        )
        SELECT 
            v_checklist_id,
            COALESCE((item->>'category')::TEXT, 'General'),
            (item->>'title')::TEXT,
            COALESCE((item->>'description')::TEXT, ''),
            COALESCE((item->>'priority')::TEXT, 'medium'),
            COALESCE((item->>'estimated_minutes')::INTEGER, 15),
            ROW_NUMBER() OVER ()
        FROM jsonb_array_elements(v_template.items_template) AS item;
        
        -- Atualizar contador do template
        UPDATE public.checklist_templates
        SET usage_count = usage_count + 1
        WHERE id = v_template.id;
    END IF;
    
    RETURN v_checklist_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.create_website_audit_checklist(p_user_id uuid, p_title text DEFAULT 'Auditoria Completa de Website'::text, p_description text DEFAULT 'Checklist abrangente para auditoria de performance, SEO, segurana e UX'::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    v_checklist_id UUID;
    v_items jsonb;
BEGIN
    -- Validar usurio
    IF p_user_id IS NULL THEN
        RAISE EXCEPTION 'User ID  obrigatrio';
    END IF;

    -- Verificar se usurio existe
    IF NOT EXISTS (SELECT 1 FROM auth.users WHERE id = p_user_id) THEN
        RAISE EXCEPTION 'Usurio no encontrado';
    END IF;

    -- Criar checklist principal
    INSERT INTO public.interactive_checklists (
        title,
        description,
        user_id,
        estimated_time_minutes,
        checklist_type,
        total_items,
        completed_items,
        progress_percentage,
        status
    ) VALUES (
        p_title,
        p_description,
        p_user_id,
        120,
        'website_audit',
        0, -- Ser atualizado pelo trigger
        0,
        0,
        'not_started'
    ) RETURNING id INTO v_checklist_id;

    -- Template de itens de auditoria
    v_items := '[
        {
            "category": "Performance",
            "title": "Verificar velocidade de carregamento",
            "description": "Usar PageSpeed Insights ou GTmetrix para medir Core Web Vitals",
            "priority": "high",
            "difficulty": "easy",
            "estimated_minutes": 10,
            "sort_order": 1
        },
        {
            "category": "Performance", 
            "title": "Otimizar imagens para web",
            "description": "Verificar compresso e formatos adequados (WebP, AVIF)",
            "priority": "high",
            "difficulty": "medium",
            "estimated_minutes": 15,
            "sort_order": 2
        },
        {
            "category": "Performance",
            "title": "Revisar e minificar CSS/JS",
            "description": "Verificar se arquivos esto minificados e otimizados",
            "priority": "medium",
            "difficulty": "medium",
            "estimated_minutes": 20,
            "sort_order": 3
        },
        {
            "category": "SEO",
            "title": "Verificar meta tags essenciais",
            "description": "Confirmar title, description, canonical e OpenGraph",
            "priority": "high",
            "difficulty": "easy",
            "estimated_minutes": 8,
            "sort_order": 4
        },
        {
            "category": "SEO",
            "title": "Analisar estrutura de headings",
            "description": "Verificar hierarquia H1-H6 correta e semntica",
            "priority": "high",
            "difficulty": "easy",
            "estimated_minutes": 10,
            "sort_order": 5
        },
        {
            "category": "SEO",
            "title": "Validar sitemap e robots.txt",
            "description": "Confirmar sitemap atualizado e robots.txt configurado",
            "priority": "medium",
            "difficulty": "easy",
            "estimated_minutes": 5,
            "sort_order": 6
        },
        {
            "category": "Segurana",
            "title": "Verificar certificado SSL/HTTPS",
            "description": "Confirmar SSL vlido e redirecionamento HTTPS",
            "priority": "high",
            "difficulty": "easy",
            "estimated_minutes": 5,
            "sort_order": 7
        },
        {
            "category": "Segurana",
            "title": "Testar cabealhos de segurana",
            "description": "Verificar HSTS, CSP, X-Frame-Options e outros headers",
            "priority": "medium",
            "difficulty": "medium",
            "estimated_minutes": 12,
            "sort_order": 8
        },
        {
            "category": "UX/Acessibilidade",
            "title": "Verificar responsividade mobile",
            "description": "Testar em diferentes dispositivos e resolues",
            "priority": "high",
            "difficulty": "easy",
            "estimated_minutes": 15,
            "sort_order": 9
        },
        {
            "category": "UX/Acessibilidade",
            "title": "Testar navegao e formulrios",
            "description": "Verificar links funcionais e validao de formulrios",
            "priority": "high",
            "difficulty": "medium",
            "estimated_minutes": 20,
            "sort_order": 10
        },
        {
            "category": "UX/Acessibilidade",
            "title": "Avaliar contraste e legibilidade",
            "description": "Usar WAVE ou Lighthouse para verificar acessibilidade",
            "priority": "medium",
            "difficulty": "easy",
            "estimated_minutes": 10,
            "sort_order": 11
        }
    ]'::jsonb;

    -- Inserir itens do checklist
    INSERT INTO public.checklist_items (
        checklist_id,
        category,
        title,
        description,
        priority,
        difficulty,
        estimated_minutes,
        sort_order
    )
    SELECT 
        v_checklist_id,
        (item->>'category')::TEXT,
        (item->>'title')::TEXT,
        (item->>'description')::TEXT,
        (item->>'priority')::TEXT,
        (item->>'difficulty')::TEXT,
        (item->>'estimated_minutes')::INTEGER,
        (item->>'sort_order')::INTEGER
    FROM jsonb_array_elements(v_items) AS item;

    -- Criar log de criao
    INSERT INTO public.checklist_activity_logs (
        checklist_id,
        user_id,
        action,
        details
    ) VALUES (
        v_checklist_id,
        p_user_id,
        'checklist_created',
        jsonb_build_object(
            'title', p_title,
            'type', 'website_audit',
            'total_items', jsonb_array_length(v_items)
        )
    );

    RETURN v_checklist_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.decrypt_sensitive(encrypted_data bytea)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  encryption_key TEXT;
BEGIN
  IF encrypted_data IS NULL THEN
    RETURN NULL;
  END IF;

  encryption_key := current_setting('app.encryption_key', true);

  IF encryption_key IS NULL OR encryption_key = '' THEN
    RAISE EXCEPTION 'Encryption key not configured';
  END IF;

  RETURN pgp_sym_decrypt(encrypted_data, encryption_key);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.downgrade_to_free(p_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  UPDATE user_profiles
  SET
    tier = 'free',
    subscription_status = 'canceled',
    subscription_end_date = NOW(),
    updated_at = NOW()
  WHERE id = p_user_id;

  -- Log downgrade
  INSERT INTO audit_log (user_id, action, resource_type, resource_id, details)
  VALUES (p_user_id, 'tier_downgrade', 'user_profiles', p_user_id, '{"from": "paid", "to": "free"}'::jsonb);

  RAISE NOTICE 'User % downgraded to FREE tier', p_user_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.encrypt_sensitive(data text)
 RETURNS bytea
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  encryption_key TEXT;
BEGIN
  -- Get encryption key from environment (or Vault)
  encryption_key := current_setting('app.encryption_key', true);

  IF encryption_key IS NULL OR encryption_key = '' THEN
    RAISE EXCEPTION 'Encryption key not configured';
  END IF;

  RETURN pgp_sym_encrypt(data, encryption_key);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.enforce_tier_limits()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  user_tier TEXT;
  current_count INT;
  max_limit INT;
BEGIN
  -- Get user tier and current usage
  SELECT tier, monthly_analysis_count
  INTO user_tier, current_count
  FROM user_profiles
  WHERE id = NEW.user_id;

  -- If user not found (should not happen with FK), allow
  IF user_tier IS NULL THEN
    RETURN NEW;
  END IF;

  -- Set limits based on tier
  IF user_tier = 'free' THEN
    max_limit := 3;
  ELSE
    max_limit := 999999; -- Unlimited for paid users
  END IF;

  -- Check if limit exceeded
  IF current_count >= max_limit THEN
    RAISE EXCEPTION 'Limite de anlises atingido (% de %). Faa upgrade para o plano PRO para continuar.',
      current_count, max_limit
      USING HINT = 'Acesse https://arco.consultingarco.com/pricing para ver os planos';
  END IF;

  -- Increment counter
  UPDATE user_profiles
  SET monthly_analysis_count = monthly_analysis_count + 1,
      updated_at = NOW()
  WHERE id = NEW.user_id;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.generate_share_token()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NEW.is_public = true AND NEW.share_token IS NULL THEN
    NEW.share_token = encode(gen_random_bytes(16), 'hex');
  END IF;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_admin_stats()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    total_users INT;
    total_clients INT;
    total_leads INT;
    total_tasks INT;
    active_clients INT;
    pending_tasks INT;
    completed_tasks INT;
    new_leads INT;
    converted_leads INT;
BEGIN
    -- Contar usurios
    SELECT COUNT(*) INTO total_users FROM auth.users;
    
    -- Contar clientes
    SELECT COUNT(*) INTO total_clients FROM public.clients;
    SELECT COUNT(*) INTO active_clients FROM public.clients WHERE status = 'active';
    
    -- Contar leads
    SELECT COUNT(*) INTO total_leads FROM public.leads;
    SELECT COUNT(*) INTO new_leads FROM public.leads WHERE status = 'new';
    SELECT COUNT(*) INTO converted_leads FROM public.leads WHERE status = 'converted';
    
    -- Contar tarefas
    SELECT COUNT(*) INTO total_tasks FROM public.tasks;
    SELECT COUNT(*) INTO pending_tasks FROM public.tasks WHERE status = 'pending';
    SELECT COUNT(*) INTO completed_tasks FROM public.tasks WHERE status = 'completed';
    
    RETURN json_build_object(
        'total_users', COALESCE(total_users, 0),
        'total_clients', COALESCE(total_clients, 0),
        'active_clients', COALESCE(active_clients, 0),
        'total_leads', COALESCE(total_leads, 0),
        'new_leads', COALESCE(new_leads, 0),
        'converted_leads', COALESCE(converted_leads, 0),
        'total_tasks', COALESCE(total_tasks, 0),
        'pending_tasks', COALESCE(pending_tasks, 0),
        'completed_tasks', COALESCE(completed_tasks, 0)
    );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_audit_log(filter_table text DEFAULT NULL::text, filter_action text DEFAULT NULL::text, filter_user_id uuid DEFAULT NULL::uuid, limit_count integer DEFAULT 50, offset_count integer DEFAULT 0)
 RETURNS TABLE(id uuid, user_email text, user_role text, action text, table_name text, record_id uuid, changed_fields text[], created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        a.id,
        a.user_email,
        a.user_role,
        a.action,
        a.table_name,
        a.record_id,
        a.changed_fields,
        a.created_at
    FROM public.audit_log a
    WHERE 
        (filter_table IS NULL OR a.table_name = filter_table)
        AND (filter_action IS NULL OR a.action = filter_action)
        AND (filter_user_id IS NULL OR a.user_id = filter_user_id)
    ORDER BY a.created_at DESC
    LIMIT limit_count
    OFFSET offset_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_available_slots(p_consultoria_id uuid, p_date date)
 RETURNS TABLE(time_slot time without time zone, is_available boolean)
 LANGUAGE plpgsql
 STABLE
AS $function$
BEGIN
  RETURN QUERY
  WITH time_slots AS (
    SELECT 
      ca.start_time + (interval '1 hour' * generate_series(0, 
        EXTRACT(HOUR FROM (ca.end_time - ca.start_time))::INTEGER - 1
      )) AS slot_time
    FROM consultant_availability ca
    WHERE ca.consultoria_type_id = p_consultoria_id
      AND ca.day_of_week = EXTRACT(DOW FROM p_date)::INTEGER
      AND ca.is_active = true
  )
  SELECT 
    ts.slot_time::TIME,
    NOT EXISTS (
      SELECT 1 FROM consultoria_bookings cb
      WHERE cb.consultoria_type_id = p_consultoria_id
        AND cb.scheduled_date = p_date
        AND cb.scheduled_time = ts.slot_time::TIME
        AND cb.booking_status NOT IN ('cancelled', 'no_show')
    ) AS is_available
  FROM time_slots ts
  ORDER BY ts.slot_time;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_checklist_stats(p_checklist_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    stats JSONB;
BEGIN
    SELECT jsonb_build_object(
        'total_items', COUNT(*),
        'completed_items', COUNT(*) FILTER (WHERE is_completed = TRUE),
        'progress_percentage', ROUND(
            CASE 
                WHEN COUNT(*) > 0 THEN (COUNT(*) FILTER (WHERE is_completed = TRUE)::DECIMAL / COUNT(*)::DECIMAL) * 100
                ELSE 0 
            END, 2
        ),
        'estimated_time_remaining', SUM(estimated_minutes) FILTER (WHERE is_completed = FALSE),
        'categories', jsonb_agg(DISTINCT category),
        'priority_breakdown', jsonb_object_agg(
            priority, 
            COUNT(*) FILTER (WHERE priority = checklist_items.priority)
        )
    )
    INTO stats
    FROM public.checklist_items
    WHERE checklist_id = p_checklist_id;
    
    RETURN stats;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_checklist_with_stats(p_checklist_id uuid)
 RETURNS TABLE(id uuid, title text, description text, user_id uuid, status text, checklist_type text, total_items integer, completed_items integer, progress_percentage numeric, estimated_time_minutes integer, actual_time_minutes integer, created_at timestamp with time zone, updated_at timestamp with time zone, items_by_category jsonb, recent_activity jsonb)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        ic.id,
        ic.title,
        ic.description,
        ic.user_id,
        ic.status,
        ic.checklist_type,
        ic.total_items,
        ic.completed_items,
        ic.progress_percentage,
        ic.estimated_time_minutes,
        ic.actual_time_minutes,
        ic.created_at,
        ic.updated_at,
        -- Estatsticas por categoria
        (
            SELECT jsonb_object_agg(
                category,
                jsonb_build_object(
                    'total', category_stats.total,
                    'completed', category_stats.completed,
                    'percentage', ROUND((category_stats.completed::DECIMAL / category_stats.total::DECIMAL) * 100, 1)
                )
            )
            FROM (
                SELECT 
                    ci.category,
                    COUNT(*) as total,
                    COUNT(*) FILTER (WHERE ci.is_completed = TRUE) as completed
                FROM public.checklist_items ci
                WHERE ci.checklist_id = p_checklist_id
                GROUP BY ci.category
            ) category_stats
        ) as items_by_category,
        -- Atividade recente
        (
            SELECT jsonb_agg(
                jsonb_build_object(
                    'action', cal.action,
                    'details', cal.details,
                    'created_at', cal.created_at
                )
                ORDER BY cal.created_at DESC
            )
            FROM (
                SELECT cal.action, cal.details, cal.created_at
                FROM public.checklist_activity_logs cal
                WHERE cal.checklist_id = p_checklist_id
                ORDER BY cal.created_at DESC
                LIMIT 10
            ) cal
        ) as recent_activity
    FROM public.interactive_checklists ic
    WHERE ic.id = p_checklist_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_client_domain()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    user_id UUID;
    domain_data JSON;
BEGIN
    -- Pegar ID do usurio autenticado
    user_id := auth.uid();
    
    IF user_id IS NULL THEN
        RAISE EXCEPTION 'User not authenticated';
    END IF;
    
    -- Buscar anlise de domnio mais recente do usurio
    SELECT json_build_object(
        'domain', dar.domain,
        'isVerified', dar.status = 'analyzed',
        'ssl', json_build_object(
            'enabled', COALESCE(dar.ssl_enabled, false),
            'expiry', COALESCE(dar.ssl_expiry::TEXT, ''),
            'issuer', COALESCE(dar.ssl_issuer, 'Unknown')
        ),
        'dns', json_build_object(
            'status', CASE 
                WHEN dar.status = 'analyzed' THEN 'healthy'
                WHEN dar.status = 'identified' THEN 'warning'
                ELSE 'error'
            END,
            'records', '[]'::json  -- Placeholder: implementar quando tiver tabela dns_records
        ),
        'performance', json_build_object(
            'speed', COALESCE(dar.performance_score, 0),
            'seo', COALESCE(dar.seo_score, 0),
            'accessibility', COALESCE(dar.accessibility_score, 0),
            'bestPractices', COALESCE(dar.best_practices_score, 0)
        ),
        'pages', '[]'::json,  -- Placeholder: implementar quando tiver tabela page_analytics
        'created_at', dar.created_at,
        'updated_at', dar.updated_at
    ) INTO domain_data
    FROM public.domain_analysis_requests dar
    WHERE dar.user_id = user_id
    ORDER BY dar.created_at DESC
    LIMIT 1;
    
    -- Se no houver dados, retornar null
    RETURN COALESCE(domain_data, NULL);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_client_metrics()
 RETURNS json
 LANGUAGE sql
 SECURITY DEFINER
AS $function$
  SELECT public.get_client_metrics_enhanced();
$function$
;

CREATE OR REPLACE FUNCTION public.get_client_metrics_enhanced()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  current_period_start date := current_date - interval '30 days';
  previous_period_start date := current_date - interval '60 days';
  previous_period_end date := current_date - interval '30 days';
  current_leads integer := 0;
  previous_leads integer := 0;
  current_conversions integer := 0;
  previous_conversions integer := 0;
  current_views integer := 0;
  previous_views integer := 0;
  leads_change numeric := 0;
  conversions_change numeric := 0;
  views_change numeric := 0;
  roi_value numeric := 0;
  roi_change numeric := 0;
  conversion_rate numeric := 0;
BEGIN
  -- Get current user (client role assumed)
  IF auth.uid() IS NULL THEN
    RAISE EXCEPTION 'Not authenticated';
  END IF;

  -- Calculate current period leads
  SELECT COUNT(*)
  INTO current_leads
  FROM leads
  WHERE user_id = auth.uid()
    AND created_at >= current_period_start
    AND created_at <= current_date;

  -- Calculate previous period leads
  SELECT COUNT(*)
  INTO previous_leads
  FROM leads
  WHERE user_id = auth.uid()
    AND created_at >= previous_period_start
    AND created_at < previous_period_end;

  -- Calculate current period conversions
  SELECT COUNT(*)
  INTO current_conversions
  FROM leads
  WHERE user_id = auth.uid()
    AND status = 'converted'
    AND updated_at >= current_period_start
    AND updated_at <= current_date;

  -- Calculate previous period conversions
  SELECT COUNT(*)
  INTO previous_conversions
  FROM leads
  WHERE user_id = auth.uid()
    AND status = 'converted'
    AND updated_at >= previous_period_start
    AND updated_at < previous_period_end;

  -- Calculate page views (mock for now, would integrate with analytics API)
  current_views := (current_leads * 15) + FLOOR(random() * 1000) + 500;
  previous_views := (previous_leads * 15) + FLOOR(random() * 800) + 400;

  -- Calculate change percentages
  IF previous_leads > 0 THEN
    leads_change := ((current_leads - previous_leads)::numeric / previous_leads) * 100;
  ELSE
    leads_change := CASE WHEN current_leads > 0 THEN 100 ELSE 0 END;
  END IF;

  IF previous_conversions > 0 THEN
    conversions_change := ((current_conversions - previous_conversions)::numeric / previous_conversions) * 100;
  ELSE
    conversions_change := CASE WHEN current_conversions > 0 THEN 100 ELSE 0 END;
  END IF;

  IF previous_views > 0 THEN
    views_change := ((current_views - previous_views)::numeric / previous_views) * 100;
  ELSE
    views_change := CASE WHEN current_views > 0 THEN 100 ELSE 0 END;
  END IF;

  -- Calculate conversion rate
  IF current_leads > 0 THEN
    conversion_rate := (current_conversions::numeric / current_leads) * 100;
  ELSE
    conversion_rate := 0;
  END IF;

  -- Calculate ROI (simplified - would integrate with financial data)
  -- Base ROI calculation: (Revenue - Cost) / Cost * 100
  -- For now, using conversion-based estimation
  roi_value := GREATEST(0, (current_conversions * 5000 - current_leads * 100)::numeric / GREATEST(current_leads * 100, 1) * 100);
  
  -- ROI change (mock calculation - would be based on financial history)
  roi_change := CASE 
    WHEN roi_value > 200 THEN random() * 50 + 10
    WHEN roi_value > 100 THEN random() * 30 + 5
    ELSE random() * 20
  END;

  -- Return JSON with all metrics and changes
  RETURN json_build_object(
    'leads_generated', current_leads,
    'leads_change', ROUND(leads_change, 1),
    'conversions', current_conversions,
    'conversions_change', ROUND(conversions_change, 1),
    'conversion_rate', ROUND(conversion_rate, 2),
    'page_views', current_views,
    'views_change', ROUND(views_change, 1),
    'roi', ROUND(roi_value, 0),
    'roi_change', ROUND(roi_change, 1),
    'period', '30d',
    'period_start', current_period_start,
    'period_end', current_date,
    'updated_at', now()
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_client_stats(p_client_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    v_result JSONB;
BEGIN
    WITH client_data AS (
        SELECT 
            c.*,
            cp.business_type,
            cp.industry,
            cp.satisfaction_score,
            cp.total_projects
        FROM public.clients c
        LEFT JOIN public.client_profiles cp ON c.id = cp.client_id
        WHERE c.id = p_client_id
    ),
    interaction_stats AS (
        SELECT 
            COUNT(*) as total_interactions,
            COUNT(*) FILTER (WHERE interaction_type = 'meeting') as meetings,
            COUNT(*) FILTER (WHERE outcome = 'positive') as positive_interactions,
            MAX(created_at) as last_interaction
        FROM public.client_interactions
        WHERE client_id = p_client_id
    ),
    checklist_stats AS (
        SELECT 
            COUNT(DISTINCT ic.id) as total_checklists,
            COUNT(DISTINCT ic.id) FILTER (WHERE ic.status = 'completed') as completed_checklists,
            AVG(ic.progress_percentage) as avg_progress
        FROM public.interactive_checklists ic
        JOIN public.checklist_relationships cr ON ic.id = cr.checklist_id
        JOIN public.client_profiles cp ON cr.client_profile_id = cp.id
        WHERE cp.client_id = p_client_id
    )
    SELECT jsonb_build_object(
        'client', to_jsonb(cd.*),
        'interactions', to_jsonb(interactions.*),
        'checklists', to_jsonb(checklists.*)
    ) INTO v_result
    FROM client_data cd, interaction_stats interactions, checklist_stats checklists;
    
    RETURN v_result;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_client_timeline(p_limit integer DEFAULT 50)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    user_id UUID;
    timeline_events JSON;
BEGIN
    -- Pegar ID do usurio autenticado
    user_id := auth.uid();
    
    IF user_id IS NULL THEN
        RAISE EXCEPTION 'User not authenticated';
    END IF;
    
    -- Buscar eventos do audit_log do usurio
    SELECT json_agg(
        json_build_object(
            'id', al.id::TEXT,
            'type', CASE 
                WHEN al.action = 'INSERT' THEN 'milestone'
                WHEN al.action = 'UPDATE' THEN 'document'
                WHEN al.action = 'DELETE' THEN 'call'
                ELSE 'message'
            END,
            'title', CONCAT(al.table_name, ' ', LOWER(al.action)),
            'description', COALESCE(
                'Record ID: ' || COALESCE(al.record_id::TEXT, 'N/A'),
                'Action performed'
            ),
            'timestamp', al.created_at,
            'metadata', json_build_object(
                'table', al.table_name,
                'action', al.action,
                'status', 'completed'
            )
        )
        ORDER BY al.created_at DESC
    ) INTO timeline_events
    FROM public.audit_log al
    WHERE al.user_id = user_id
    LIMIT p_limit;
    
    -- Se no houver eventos, retornar array vazio
    RETURN COALESCE(timeline_events, '[]'::json);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_conversion_metrics()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    new_leads_count INT;
    converted_leads_count INT;
    conversion_rate NUMERIC;
    avg_conversion_time INTERVAL;
BEGIN
    -- Contar leads dos ltimos 30 dias
    SELECT COUNT(*) INTO new_leads_count 
    FROM public.leads 
    WHERE created_at >= NOW() - INTERVAL '30 days';
    
    -- Contar leads convertidos dos ltimos 30 dias
    SELECT COUNT(*) INTO converted_leads_count 
    FROM public.leads 
    WHERE status = 'converted' 
    AND updated_at >= NOW() - INTERVAL '30 days';
    
    -- Calcular taxa de converso
    IF new_leads_count > 0 THEN
        conversion_rate := (converted_leads_count::NUMERIC / new_leads_count::NUMERIC) * 100;
    ELSE
        conversion_rate := 0;
    END IF;
    
    -- Calcular tempo mdio de converso
    SELECT AVG(updated_at - created_at) INTO avg_conversion_time
    FROM public.leads
    WHERE status = 'converted'
    AND updated_at >= NOW() - INTERVAL '30 days';
    
    RETURN json_build_object(
        'period', '30 days',
        'new_leads', COALESCE(new_leads_count, 0),
        'converted_leads', COALESCE(converted_leads_count, 0),
        'conversion_rate', ROUND(COALESCE(conversion_rate, 0), 2),
        'avg_conversion_days', EXTRACT(DAY FROM COALESCE(avg_conversion_time, INTERVAL '0 days'))
    );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_email_summary(p_user_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_result jsonb;
BEGIN
  SELECT jsonb_build_object(
    'total_accounts', COUNT(*),
    'active_accounts', COUNT(*) FILTER (WHERE is_active = true),
    'total_messages', COALESCE(SUM(
      (SELECT COUNT(*) FROM public.email_messages WHERE account_id = ea.id)
    ), 0),
    'unread_messages', COALESCE(SUM(
      (SELECT COUNT(*) FROM public.email_messages WHERE account_id = ea.id AND is_read = false)
    ), 0)
  )
  INTO v_result
  FROM public.email_accounts ea
  WHERE ea.user_id = p_user_id;
  
  RETURN COALESCE(v_result, '{"total_accounts": 0, "active_accounts": 0, "total_messages": 0, "unread_messages": 0}'::jsonb);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_financial_summary(p_user_id uuid, p_period text DEFAULT '30d'::text)
 RETURNS TABLE(total_income numeric, total_expenses numeric, total_commissions numeric, net_profit numeric, pending_payments numeric, transaction_count integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    period_start TIMESTAMPTZ;
BEGIN
    -- Calculate period start
    period_start := CASE
        WHEN p_period = '7d' THEN NOW() - INTERVAL '7 days'
        WHEN p_period = '30d' THEN NOW() - INTERVAL '30 days'
        WHEN p_period = '90d' THEN NOW() - INTERVAL '90 days'
        WHEN p_period = '1y' THEN NOW() - INTERVAL '1 year'
        ELSE NOW() - INTERVAL '30 days'
    END;
    
    RETURN QUERY
    SELECT
        COALESCE(SUM(CASE WHEN t.type = 'income' AND t.status = 'completed' THEN t.amount ELSE 0 END), 0) as total_income,
        COALESCE(SUM(CASE WHEN t.type = 'expense' AND t.status = 'completed' THEN t.amount ELSE 0 END), 0) as total_expenses,
        COALESCE(SUM(CASE WHEN t.type = 'commission' AND t.status = 'completed' THEN t.amount ELSE 0 END), 0) as total_commissions,
        COALESCE(
            SUM(CASE WHEN t.type = 'income' AND t.status = 'completed' THEN t.amount ELSE 0 END) -
            SUM(CASE WHEN t.type = 'expense' AND t.status = 'completed' THEN t.amount ELSE 0 END) -
            SUM(CASE WHEN t.type = 'commission' AND t.status = 'completed' THEN t.amount ELSE 0 END),
            0
        ) as net_profit,
        COALESCE(SUM(CASE WHEN t.status = 'pending' THEN t.amount ELSE 0 END), 0) as pending_payments,
        COUNT(*)::INTEGER as transaction_count
    FROM public.transactions t
    WHERE t.user_id = p_user_id
    AND t.transaction_date >= period_start;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_leads_stats(p_user_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_result jsonb;
  v_has_user_id boolean;
BEGIN
  -- Check if user_id column exists
  SELECT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'leads' AND column_name = 'user_id'
  ) INTO v_has_user_id;
  
  IF v_has_user_id THEN
    -- Use user_id if available
    SELECT jsonb_build_object(
      'total_leads', COUNT(*),
      'by_status', jsonb_object_agg(status, COUNT(*)),
      'avg_score', COALESCE(AVG(score), 0)
    )
    INTO v_result
    FROM public.leads
    WHERE user_id = p_user_id
    GROUP BY status;
  ELSE
    -- Fallback to analysis_id relationship
    SELECT jsonb_build_object(
      'total_leads', COUNT(*),
      'by_status', jsonb_object_agg(status, COUNT(*)),
      'avg_score', 0
    )
    INTO v_result
    FROM public.leads l
    WHERE l.analysis_id IN (
      SELECT id FROM public.analysis_requests WHERE user_id = p_user_id
    )
    GROUP BY status;
  END IF;
  
  RETURN COALESCE(v_result, '{"total_leads": 0, "by_status": {}, "avg_score": 0}'::jsonb);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_monthly_revenue()
 RETURNS numeric
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    revenue NUMERIC;
BEGIN
    -- TODO: Implementar clculo real quando tiver tabela de revenue/transactions
    -- Por enquanto, retorna um clculo estimado baseado em clientes ativos
    SELECT COUNT(*) * 5000.00 INTO revenue 
    FROM public.clients 
    WHERE status = 'active'
    AND created_at >= DATE_TRUNC('month', NOW());
    
    RETURN COALESCE(revenue, 0);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_recent_activity(limit_count integer DEFAULT 10)
 RETURNS TABLE(activity_type text, description text, created_at timestamp with time zone, user_email text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        'client'::TEXT as activity_type,
        'Novo cliente: ' || c.name as description,
        c.created_at,
        u.email as user_email
    FROM public.clients c
    LEFT JOIN auth.users u ON u.id = c.created_by
    ORDER BY c.created_at DESC
    LIMIT limit_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_record_history(p_table_name text, p_record_id uuid)
 RETURNS TABLE(id uuid, user_email text, action text, changed_fields text[], old_data jsonb, new_data jsonb, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        a.id,
        a.user_email,
        a.action,
        a.changed_fields,
        a.old_data,
        a.new_data,
        a.created_at
    FROM public.audit_log a
    WHERE 
        a.table_name = p_table_name
        AND a.record_id = p_record_id
    ORDER BY a.created_at DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_storage_usage(user_uuid uuid)
 RETURNS numeric
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN (
    SELECT COALESCE(SUM(size_bytes), 0) / (1024.0 * 1024.0)  -- Convert to MB
    FROM storage_items 
    WHERE client_id = user_uuid
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_active_subscription(p_user_id uuid)
 RETURNS TABLE(subscription_id uuid, plan_name text, plan_slug text, status text, current_period_end timestamp with time zone, cancel_at_period_end boolean)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    s.id,
    sp.name,
    sp.slug,
    s.status,
    s.current_period_end,
    s.cancel_at_period_end
  FROM public.subscriptions s
  JOIN public.subscription_plans sp ON s.plan_id = sp.id
  WHERE s.user_id = p_user_id
    AND s.status = 'active'
  ORDER BY s.created_at DESC
  LIMIT 1;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_leads(p_limit integer DEFAULT 10)
 RETURNS TABLE(id uuid, email text, name text, phone text, source text, status text, metadata jsonb, client_id uuid, client_name text, client_company text, created_at timestamp with time zone, updated_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    user_id UUID;
BEGIN
    -- Pegar ID do usurio autenticado
    user_id := auth.uid();
    
    IF user_id IS NULL THEN
        RAISE EXCEPTION 'User not authenticated';
    END IF;
    
    -- Retornar leads recentes
    RETURN QUERY
    SELECT 
        l.id,
        l.email,
        l.name,
        l.phone,
        l.source,
        l.status,
        l.metadata,
        c.id as client_id,
        c.name as client_name,
        c.company as client_company,
        l.created_at,
        l.updated_at
    FROM public.leads l
    LEFT JOIN public.clients c ON c.created_by = user_id
    WHERE l.assigned_to = user_id
    ORDER BY l.created_at DESC
    LIMIT p_limit;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_payment_history(p_user_id uuid, p_limit integer DEFAULT 10)
 RETURNS TABLE(transaction_id uuid, amount numeric, currency text, status text, payment_method_type text, paid_at timestamp with time zone, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    pt.id,
    pt.amount,
    pt.currency,
    pt.status,
    pt.payment_method_type,
    pt.paid_at,
    pt.created_at
  FROM public.payment_transactions pt
  WHERE pt.user_id = p_user_id
  ORDER BY pt.created_at DESC
  LIMIT p_limit;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_stats()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    user_id UUID;
    my_leads_count INT;
    new_today_count INT;
    my_tasks_count INT;
    urgent_tasks_count INT;
    appointments_today_count INT;
    conversions_month_count INT;
BEGIN
    -- Pegar ID do usurio autenticado
    user_id := auth.uid();
    
    IF user_id IS NULL THEN
        RAISE EXCEPTION 'User not authenticated';
    END IF;
    
    -- Contar leads do usurio
    SELECT COUNT(*) INTO my_leads_count
    FROM public.leads
    WHERE assigned_to = user_id;
    
    -- Contar leads novos hoje
    SELECT COUNT(*) INTO new_today_count
    FROM public.leads
    WHERE assigned_to = user_id
    AND DATE(created_at) = CURRENT_DATE;
    
    -- Contar tasks pendentes
    SELECT COUNT(*) INTO my_tasks_count
    FROM public.tasks
    WHERE assigned_to = user_id
    AND status = 'pending';
    
    -- Contar tasks urgentes
    SELECT COUNT(*) INTO urgent_tasks_count
    FROM public.tasks
    WHERE assigned_to = user_id
    AND priority = 'high'
    AND status = 'pending';
    
    -- Contar agendamentos hoje
    SELECT COUNT(*) INTO appointments_today_count
    FROM public.tasks
    WHERE assigned_to = user_id
    AND DATE(due_date) = CURRENT_DATE;
    
    -- Contar converses do ms
    SELECT COUNT(*) INTO conversions_month_count
    FROM public.leads
    WHERE assigned_to = user_id
    AND status = 'converted'
    AND DATE_TRUNC('month', updated_at) = DATE_TRUNC('month', CURRENT_DATE);
    
    -- Retornar JSON
    RETURN json_build_object(
        'my_leads', COALESCE(my_leads_count, 0),
        'new_today', COALESCE(new_today_count, 0),
        'my_tasks', COALESCE(my_tasks_count, 0),
        'urgent_tasks', COALESCE(urgent_tasks_count, 0),
        'appointments_today', COALESCE(appointments_today_count, 0),
        'conversions_month', COALESCE(conversions_month_count, 0)
    );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_storage_usage(p_user_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_result jsonb;
BEGIN
  SELECT jsonb_build_object(
    'total_files', COUNT(*),
    'total_size', COALESCE(SUM(size), 0),
    'by_type', jsonb_object_agg(
      COALESCE(SPLIT_PART(mime_type, '/', 1), 'other'),
      type_stats
    )
  )
  INTO v_result
  FROM (
    SELECT
      mime_type,
      jsonb_build_object(
        'count', COUNT(*),
        'size', SUM(size)
      ) as type_stats
    FROM public.cloud_files
    WHERE user_id = p_user_id
      AND deleted_at IS NULL
    GROUP BY SPLIT_PART(mime_type, '/', 1), mime_type
  ) subq;
  
  RETURN COALESCE(v_result, '{"total_files": 0, "total_size": 0, "by_type": {}}'::jsonb);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_tasks(p_date date DEFAULT CURRENT_DATE)
 RETURNS TABLE(id uuid, title text, description text, due_date timestamp with time zone, status text, priority text, client_id uuid, client_name text, category text, start_time timestamp with time zone, end_time timestamp with time zone, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    user_id UUID;
BEGIN
    -- Pegar ID do usurio autenticado
    user_id := auth.uid();
    
    IF user_id IS NULL THEN
        RAISE EXCEPTION 'User not authenticated';
    END IF;
    
    -- Retornar tasks do dia
    RETURN QUERY
    SELECT 
        t.id,
        t.title,
        t.description,
        t.due_date,
        t.status,
        t.priority,
        t.client_id,
        c.name as client_name,
        t.category,
        t.start_time,
        t.end_time,
        t.created_at
    FROM public.tasks t
    LEFT JOIN public.clients c ON t.client_id = c.id
    WHERE t.assigned_to = user_id
    AND DATE(t.due_date) = p_date
    ORDER BY 
        CASE t.priority 
            WHEN 'high' THEN 1
            WHEN 'medium' THEN 2
            WHEN 'low' THEN 3
        END,
        t.due_date ASC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_usage_stats(p_user_id uuid)
 RETURNS TABLE(tier text, analyses_used integer, analyses_limit integer, storage_used_mb numeric, storage_limit_mb numeric, analyses_percentage integer, storage_percentage integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    up.tier,
    up.monthly_analysis_count,
    CASE WHEN up.tier = 'free' THEN 3 ELSE 999999 END AS analyses_limit,
    up.storage_used_mb,
    CASE WHEN up.tier = 'free' THEN 100.0 ELSE 10000.0 END AS storage_limit_mb,
    CASE
      WHEN up.tier = 'free' THEN LEAST(100, ROUND((up.monthly_analysis_count::DECIMAL / 3) * 100))
      ELSE 0
    END AS analyses_percentage,
    CASE
      WHEN up.tier = 'free' THEN LEAST(100, ROUND((up.storage_used_mb / 100.0) * 100))
      ELSE LEAST(100, ROUND((up.storage_used_mb / 10000.0) * 100))
    END AS storage_percentage
  FROM user_profiles up
  WHERE up.id = p_user_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  user_full_name TEXT;
BEGIN
  -- Extract full_name from user metadata
  user_full_name := NEW.raw_user_meta_data->>'full_name';

  -- Create user_profiles entry
  INSERT INTO public.user_profiles (
    id,
    full_name,
    tier,
    user_type,
    created_at,
    updated_at
  )
  VALUES (
    NEW.id,
    user_full_name,
    'free',
    'client',
    NOW(),
    NOW()
  );

  -- Seed default financial categories for new user
  -- (Only if finance system is enabled - safe to fail)
  BEGIN
    PERFORM public.seed_default_financial_categories(NEW.id);
  EXCEPTION
    WHEN OTHERS THEN
      -- Silently fail if function doesn't exist (finance migration not applied yet)
      NULL;
  END;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_admin()
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM user_profiles 
    WHERE id = auth.uid() 
    AND user_type = 'admin'
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_paid_tier()
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM user_profiles 
    WHERE id = auth.uid() 
    AND tier = 'paid'
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.process_webhook_event(p_gateway text, p_gateway_event_id text, p_event_type text, p_payload jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_webhook_id UUID;
  v_payment_id TEXT;
  v_subscription_id UUID;
  v_user_id UUID;
  v_status TEXT;
  v_amount DECIMAL;
  v_result JSONB;
BEGIN
  -- 1. Verificar se webhook j foi processado (idempotncia)
  SELECT id INTO v_webhook_id
  FROM public.webhook_events
  WHERE gateway_event_id = p_gateway_event_id;
  
  IF FOUND THEN
    v_result := jsonb_build_object(
      'success', TRUE,
      'message', 'Webhook already processed',
      'webhook_id', v_webhook_id
    );
    RETURN v_result;
  END IF;
  
  -- 2. Inserir webhook event
  INSERT INTO public.webhook_events (
    gateway,
    gateway_event_id,
    event_type,
    payload,
    processed
  )
  VALUES (
    p_gateway,
    p_gateway_event_id,
    p_event_type,
    p_payload,
    FALSE
  )
  RETURNING id INTO v_webhook_id;
  
  -- 3. Processar evento baseado no tipo
  IF p_event_type = 'payment' THEN
    -- Extrair dados do pagamento
    v_payment_id := p_payload->>'id';
    v_status := p_payload->>'status';
    v_amount := (p_payload->>'transaction_amount')::DECIMAL;
    v_user_id := (p_payload->'metadata'->>'user_id')::UUID;
    v_subscription_id := (p_payload->'metadata'->>'subscription_id')::UUID;
    
    -- Inserir/atualizar transao
    INSERT INTO public.payment_transactions (
      user_id,
      subscription_id,
      gateway,
      gateway_transaction_id,
      gateway_order_id,
      amount,
      status,
      payment_method_type,
      paid_at,
      metadata
    )
    VALUES (
      v_user_id,
      v_subscription_id,
      p_gateway,
      v_payment_id,
      p_payload->>'order_id',
      v_amount,
      CASE 
        WHEN v_status = 'approved' THEN 'succeeded'
        WHEN v_status = 'pending' THEN 'pending'
        WHEN v_status IN ('rejected', 'cancelled') THEN 'failed'
        ELSE v_status
      END,
      p_payload->>'payment_method_id',
      CASE WHEN v_status = 'approved' THEN NOW() ELSE NULL END,
      p_payload
    )
    ON CONFLICT (gateway_transaction_id) 
    DO UPDATE SET
      status = EXCLUDED.status,
      paid_at = EXCLUDED.paid_at,
      updated_at = NOW();
    
    -- Se pagamento aprovado, ativar subscription
    IF v_status = 'approved' AND v_subscription_id IS NOT NULL THEN
      PERFORM public.activate_subscription(v_subscription_id, v_payment_id);
    END IF;
    
  END IF;
  
  -- 4. Marcar webhook como processado
  UPDATE public.webhook_events
  SET 
    processed = TRUE,
    processed_at = NOW()
  WHERE id = v_webhook_id;
  
  -- 5. Retornar resultado
  v_result := jsonb_build_object(
    'success', TRUE,
    'webhook_id', v_webhook_id,
    'event_type', p_event_type,
    'processed_at', NOW()
  );
  
  RETURN v_result;
  
EXCEPTION WHEN OTHERS THEN
  -- Log erro no webhook event
  UPDATE public.webhook_events
  SET 
    error_message = SQLERRM,
    retry_count = retry_count + 1
  WHERE id = v_webhook_id;
  
  -- Retornar erro
  v_result := jsonb_build_object(
    'success', FALSE,
    'error', SQLERRM,
    'webhook_id', v_webhook_id
  );
  
  RETURN v_result;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.seed_default_financial_categories(p_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    -- Income categories
    INSERT INTO public.financial_categories (user_id, name, type, color, icon)
    VALUES
        (p_user_id, 'Venda', 'income', '#10b981', 'trending-up'),
        (p_user_id, 'Locao', 'income', '#3b82f6', 'home'),
        (p_user_id, 'Consultoria', 'income', '#8b5cf6', 'briefcase'),
        (p_user_id, 'Outros Recebimentos', 'income', '#6366f1', 'dollar-sign')
    ON CONFLICT (user_id, name) DO NOTHING;
    
    -- Expense categories
    INSERT INTO public.financial_categories (user_id, name, type, color, icon)
    VALUES
        (p_user_id, 'Marketing', 'expense', '#ef4444', 'megaphone'),
        (p_user_id, 'Operacional', 'expense', '#f59e0b', 'settings'),
        (p_user_id, 'Pessoal', 'expense', '#ec4899', 'users'),
        (p_user_id, 'Tecnologia', 'expense', '#06b6d4', 'cpu'),
        (p_user_id, 'Outros Gastos', 'expense', '#64748b', 'minus-circle')
    ON CONFLICT (user_id, name) DO NOTHING;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.set_encrypted_payment_ref_invoices()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF NEW.payment_reference IS NOT NULL AND NEW.payment_reference != '' THEN
    NEW.payment_reference_encrypted := encrypt_sensitive(NEW.payment_reference);
  END IF;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.set_encrypted_payment_ref_transactions()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF NEW.payment_reference IS NOT NULL AND NEW.payment_reference != '' THEN
    NEW.payment_reference_encrypted := encrypt_sensitive(NEW.payment_reference);
  END IF;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.set_encrypted_phone()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF NEW.phone IS NOT NULL AND NEW.phone != '' THEN
    NEW.phone_encrypted := encrypt_sensitive(NEW.phone);
    -- Optionally clear plaintext (for max security)
    -- NEW.phone := NULL;
  END IF;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.set_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.table_exists(table_name text)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 
    FROM information_schema.tables 
    WHERE table_schema = 'public' 
      AND information_schema.tables.table_name = table_exists.table_name
  );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.trigger_domain_check()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN PERFORM check_domain_health(); END; $function$
;

CREATE OR REPLACE FUNCTION public.trigger_lighthouse_scan()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  edge_function_url TEXT;
  request_id BIGINT;
BEGIN
  -- Get Edge Function URL from environment or use default
  -- Format: https://{project_ref}.supabase.co/functions/v1/lighthouse-scan
  edge_function_url := current_setting('app.edge_function_url', true);
  
  IF edge_function_url IS NULL THEN
    edge_function_url := 'https://' || current_setting('app.supabase_project_ref', true) || '.supabase.co/functions/v1/lighthouse-scan';
  END IF;

  -- Make async HTTP POST to Edge Function
  -- This returns immediately, Edge Function runs in background
  SELECT INTO request_id net.http_post(
    url := edge_function_url,
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.supabase_anon_key', true)
    ),
    body := jsonb_build_object(
      'analysisId', NEW.id::TEXT,
      'url', NEW.url
    ),
    timeout_milliseconds := 30000
  );

  RAISE NOTICE 'Lighthouse scan triggered for analysis % (request_id: %)', NEW.id, request_id;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.trigger_security_check()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN PERFORM check_security(); END; $function$
;

CREATE OR REPLACE FUNCTION public.trigger_uptime_check()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN PERFORM check_uptime(); END; $function$
;

CREATE OR REPLACE FUNCTION public.update_category_stats()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    category_record RECORD;
BEGIN
    -- Update stats when transaction is inserted or updated
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        -- Find or create category
        SELECT * INTO category_record
        FROM public.financial_categories
        WHERE user_id = NEW.user_id 
        AND name = NEW.category
        AND type = CASE WHEN NEW.type = 'expense' THEN 'expense' ELSE 'income' END
        LIMIT 1;
        
        IF NOT FOUND THEN
            INSERT INTO public.financial_categories (user_id, name, type)
            VALUES (
                NEW.user_id, 
                NEW.category, 
                CASE WHEN NEW.type = 'expense' THEN 'expense' ELSE 'income' END
            );
        END IF;
        
        -- Recalculate stats
        UPDATE public.financial_categories
        SET 
            transaction_count = (
                SELECT COUNT(*) FROM public.transactions 
                WHERE user_id = NEW.user_id 
                AND category = NEW.category
                AND status = 'completed'
            ),
            total_amount = (
                SELECT COALESCE(SUM(amount), 0) FROM public.transactions 
                WHERE user_id = NEW.user_id 
                AND category = NEW.category
                AND status = 'completed'
            )
        WHERE user_id = NEW.user_id AND name = NEW.category;
    END IF;
    
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_checklist_progress()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    total_count INTEGER;
    completed_count INTEGER;
    progress_pct DECIMAL(5,2);
    new_status TEXT;
BEGIN
    -- Contar itens total e completados
    SELECT 
        COUNT(*),
        COUNT(*) FILTER (WHERE is_completed = TRUE)
    INTO total_count, completed_count
    FROM public.checklist_items
    WHERE checklist_id = NEW.checklist_id;
    
    -- Calcular progresso
    progress_pct := CASE 
        WHEN total_count > 0 THEN (completed_count::DECIMAL / total_count::DECIMAL) * 100
        ELSE 0
    END;
    
    -- Determinar status
    new_status := CASE
        WHEN progress_pct = 100 THEN 'completed'
        WHEN progress_pct > 0 THEN 'in_progress'
        ELSE 'not_started'
    END;
    
    -- Atualizar checklist
    UPDATE public.interactive_checklists
    SET 
        total_items = total_count,
        completed_items = completed_count,
        progress_percentage = progress_pct,
        status = new_status,
        completed_at = CASE WHEN new_status = 'completed' AND status != 'completed' THEN NOW() ELSE completed_at END,
        updated_at = NOW()
    WHERE id = NEW.checklist_id;
    
    -- Log da atividade
    INSERT INTO public.checklist_activity_logs (checklist_id, item_id, user_id, action, details)
    VALUES (
        NEW.checklist_id,
        NEW.id,
        COALESCE(NEW.completed_by, auth.uid()),
        CASE WHEN NEW.is_completed THEN 'item_completed' ELSE 'item_uncompleted' END,
        jsonb_build_object(
            'item_title', NEW.title,
            'previous_progress', (SELECT progress_percentage FROM public.interactive_checklists WHERE id = NEW.checklist_id),
            'new_progress', progress_pct
        )
    );
    
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_checklist_progress_and_log()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_total_items INTEGER;
    v_completed_items INTEGER;
    v_progress_percentage DECIMAL(3,1);
    v_checklist_user_id UUID;
    v_action TEXT;
    v_description TEXT;
BEGIN
    -- Determinar ao baseada no trigger
    IF TG_OP = 'INSERT' THEN
        v_action := 'item_added';
        v_description := 'Item adicionado: ' || NEW.title;
    ELSIF TG_OP = 'UPDATE' AND OLD.is_completed = FALSE AND NEW.is_completed = TRUE THEN
        v_action := 'item_completed';
        v_description := 'Item concludo: ' || NEW.title;
    ELSIF TG_OP = 'UPDATE' AND OLD.is_completed = TRUE AND NEW.is_completed = FALSE THEN
        v_action := 'item_uncompleted';
        v_description := 'Item desmarcado: ' || NEW.title;
    ELSIF TG_OP = 'DELETE' THEN
        v_action := 'item_deleted';
        v_description := 'Item removido: ' || OLD.title;
    ELSE
        -- Para outras atualizaes, apenas atualizar progresso sem log
        v_action := NULL;
    END IF;

    -- Obter user_id do checklist
    SELECT user_id INTO v_checklist_user_id
    FROM public.interactive_checklists
    WHERE id = COALESCE(NEW.checklist_id, OLD.checklist_id);

    -- Calcular estatsticas atualizadas
    SELECT 
        COUNT(*),
        COUNT(*) FILTER (WHERE is_completed = TRUE)
    INTO v_total_items, v_completed_items
    FROM public.checklist_items
    WHERE checklist_id = COALESCE(NEW.checklist_id, OLD.checklist_id);

    -- Calcular porcentagem
    IF v_total_items > 0 THEN
        v_progress_percentage := ROUND((v_completed_items::DECIMAL / v_total_items::DECIMAL) * 100, 1);
    ELSE
        v_progress_percentage := 0;
    END IF;

    -- Atualizar checklist com novas estatsticas
    UPDATE public.interactive_checklists
    SET 
        total_items = v_total_items,
        completed_items = v_completed_items,
        progress_percentage = v_progress_percentage,
        status = CASE 
            WHEN v_progress_percentage = 0 THEN 'not_started'
            WHEN v_progress_percentage = 100 THEN 'completed'
            ELSE 'in_progress'
        END,
        updated_at = NOW()
    WHERE id = COALESCE(NEW.checklist_id, OLD.checklist_id);

    -- Criar log de atividade apenas se necessrio e se temos user_id
    IF v_action IS NOT NULL AND v_checklist_user_id IS NOT NULL THEN
        INSERT INTO public.checklist_activity_logs (
            checklist_id,
            user_id,
            item_id,
            action,
            details
        ) VALUES (
            COALESCE(NEW.checklist_id, OLD.checklist_id),
            v_checklist_user_id,
            COALESCE(NEW.id, OLD.id),
            v_action,
            jsonb_build_object(
                'item_title', COALESCE(NEW.title, OLD.title),
                'category', COALESCE(NEW.category, OLD.category),
                'priority', COALESCE(NEW.priority, OLD.priority),
                'progress_percentage', v_progress_percentage,
                'total_items', v_total_items,
                'completed_items', v_completed_items
            )
        );
    END IF;

    RETURN COALESCE(NEW, OLD);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_clients_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_cloud_files_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_commissions_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_contact_message_stats()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE public.whatsapp_contacts
        SET 
            total_messages = total_messages + 1,
            last_message_at = NEW.sent_at,
            unread_count = CASE 
                WHEN NEW.direction = 'inbound' THEN unread_count + 1
                ELSE unread_count
            END
        WHERE id = NEW.contact_id;
    END IF;
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_financial_categories_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_invoices_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_storage_usage()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  file_size_mb DECIMAL;
BEGIN
  -- Convert bytes to MB
  IF TG_OP = 'INSERT' THEN
    file_size_mb := NEW.size_bytes / 1048576.0;

    UPDATE user_profiles
    SET storage_used_mb = storage_used_mb + file_size_mb,
        updated_at = NOW()
    WHERE id = NEW.user_id;

  ELSIF TG_OP = 'DELETE' THEN
    file_size_mb := OLD.size_bytes / 1048576.0;

    UPDATE user_profiles
    SET storage_used_mb = GREATEST(0, storage_used_mb - file_size_mb),
        updated_at = NOW()
    WHERE id = OLD.user_id;
  END IF;

  RETURN COALESCE(NEW, OLD);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_tasks_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_transactions_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_whatsapp_contacts_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.upgrade_to_paid(p_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  UPDATE user_profiles
  SET
    tier = 'paid',
    subscription_status = 'active',
    subscription_start_date = NOW(),
    monthly_analysis_count = 0, -- Reset counter on upgrade
    updated_at = NOW()
  WHERE id = p_user_id;

  -- Log upgrade
  INSERT INTO audit_log (user_id, action, resource_type, resource_id, details)
  VALUES (p_user_id, 'tier_upgrade', 'user_profiles', p_user_id, '{"from": "free", "to": "paid"}'::jsonb);

  RAISE NOTICE 'User % upgraded to PAID tier', p_user_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.upsert_subscription(p_user_id uuid, p_plan_slug text, p_gateway text, p_gateway_subscription_id text, p_status text DEFAULT 'incomplete'::text, p_current_period_start timestamp with time zone DEFAULT now(), p_current_period_end timestamp with time zone DEFAULT (now() + '30 days'::interval))
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_subscription_id UUID;
  v_plan_id UUID;
BEGIN
  -- Buscar plan_id pelo slug
  SELECT id INTO v_plan_id
  FROM public.subscription_plans
  WHERE slug = p_plan_slug AND is_active = TRUE;
  
  IF v_plan_id IS NULL THEN
    RAISE EXCEPTION 'Plan with slug % not found or inactive', p_plan_slug;
  END IF;
  
  -- Inserir ou atualizar subscription
  INSERT INTO public.subscriptions (
    user_id,
    plan_id,
    gateway,
    gateway_subscription_id,
    status,
    current_period_start,
    current_period_end
  )
  VALUES (
    p_user_id,
    v_plan_id,
    p_gateway,
    p_gateway_subscription_id,
    p_status,
    p_current_period_start,
    p_current_period_end
  )
  ON CONFLICT (gateway_subscription_id) 
  DO UPDATE SET
    status = EXCLUDED.status,
    current_period_start = EXCLUDED.current_period_start,
    current_period_end = EXCLUDED.current_period_end,
    updated_at = NOW()
  RETURNING id INTO v_subscription_id;
  
  RETURN v_subscription_id;
END;
$function$
;


