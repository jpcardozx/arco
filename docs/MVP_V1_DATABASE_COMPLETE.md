# üóÑÔ∏è ARCO MVP V1.0 - DATABASE ARCHITECTURE COMPLETE

## üìä OVERVIEW

**Total Tables:** 21  
**Total Indexes:** 70+  
**Total RLS Policies:** 60+  
**Total Triggers:** 10  
**Blueprint Source:** Open Source Navigation & Features Draft

---

## üéØ TABELAS POR CAMADA

### **CAMADA 1: Portal de Diagn√≥stico (Free User)**

| # | Tabela | Prop√≥sito | Features Relacionadas |
|---|--------|-----------|----------------------|
| 1 | `user_profiles` | Sistema de tiers (free/paid) + perfil estendido | Todas as features |
| 2 | `analysis_requests` | Submiss√µes de an√°lise de URL | Relat√≥rio Consolidado |
| 3 | `analysis_results` | Resultados do Lighthouse + ARCO Index | An√°lise de Performance |
| 4 | `playbooks` | Recomenda√ß√µes de otimiza√ß√£o (MDX) | Sum√°rio de Otimiza√ß√µes |

**Features Implementadas:**
- ‚úÖ Relat√≥rio Consolidado (`/diagnostico/[id]`)
- ‚úÖ An√°lise de Performance (`/diagnostico/[id]/performance`)
- ‚úÖ An√°lise de Seguran√ßa (`/diagnostico/[id]/seguranca`)
- ‚úÖ Sum√°rio de Otimiza√ß√µes (`/plano-de-acao`)
- ‚úÖ Comparativo de Planos (`/planos`)

---

### **CAMADA 2: Central do Cliente (Paid Client)**

| # | Tabela | Prop√≥sito | Features Relacionadas |
|---|--------|-----------|----------------------|
| 5 | `projects` | Projetos dos clientes | Gest√£o de Projetos |
| 6 | `project_milestones` | Cronograma e entregas | Gest√£o de Projetos |
| 7 | `performance_metrics` | Core Web Vitals di√°rios | Performance Cont√≠nua |
| 8 | `uptime_checks` | Monitoramento de uptime 24/7 | Sa√∫de de Dom√≠nio & Uptime |
| 9 | `domain_monitoring` | DNS, SSL, Blacklists | Sa√∫de de Dom√≠nio & Uptime |
| 10 | `campaigns` | Campanhas de marketing | Performance de M√≠dia Paga |
| 11 | `campaign_metrics` | M√©tricas de ads (manual V1 üé©) | Performance de M√≠dia Paga |
| 12 | `analytics_data` | Dados de analytics (manual V1 üé©) | An√°lise de Tr√°fego Web |
| 13 | `support_tickets` | Sistema de tickets | Central de Suporte |
| 14 | `support_ticket_messages` | Conversas dos tickets | Central de Suporte |
| 15 | `storage_items` | Reposit√≥rio de arquivos | Reposit√≥rio de Arquivos |
| 16 | `agency_insights` | An√°lises publicadas pela ag√™ncia | Painel Estrat√©gico |
| 17 | `integrations` | Hub de integra√ß√µes | Conex√µes (Integra√ß√µes) |
| 18 | `team_members` | Gest√£o de equipe do cliente | Gest√£o de Equipe |

**Features Implementadas:**
- ‚úÖ Painel Estrat√©gico (`/overview`)
- ‚úÖ Performance Cont√≠nua (`/saude?tab=performance`)
- ‚úÖ Seguran√ßa Ativa (`/saude?tab=seguranca`)
- ‚úÖ Sa√∫de de Dom√≠nio & Uptime (`/saude?tab=dominio`)
- ‚úÖ An√°lise de Tr√°fego Web (`/crescimento?tab=website`)
- ‚úÖ Performance de M√≠dia Paga (`/crescimento?tab=ads`)
- ‚úÖ Gest√£o de Projetos (`/operacoes?tab=projetos`)
- ‚úÖ Central de Suporte (`/operacoes?tab=suporte`)
- ‚úÖ Reposit√≥rio de Arquivos (`/operacoes?tab=arquivos`)
- ‚úÖ Portal de Faturamento (`/faturamento`)
- ‚úÖ Gest√£o de Equipe (`/equipe`)
- ‚úÖ Conex√µes (Integra√ß√µes) (`/integracoes`)

---

### **CAMADA 3: Painel de Controle (Admin)**

| # | Tabela | Prop√≥sito | Features Relacionadas |
|---|--------|-----------|----------------------|
| 19 | `leads` | Pipeline de vendas | Pipeline de Vendas |
| 20 | `proposals` | Propostas geradas (AI) | Gerador de Propostas |
| 21 | `platform_settings` | Configura√ß√µes globais | Configura√ß√µes da Plataforma |

**Features Implementadas:**
- ‚úÖ Painel da Ag√™ncia (`/admin/overview`)
- ‚úÖ Gest√£o de Clientes (`/admin/clientes`)
- ‚úÖ Perfil do Cliente + Impersonation (`/admin/clientes/[id]`)
- ‚úÖ Pipeline de Vendas (`/admin/vendas`)
- ‚úÖ Gerador de Propostas (`/admin/propostas`)
- ‚úÖ Opera√ß√µes Globais (`/admin/operacoes`)
- ‚úÖ Gest√£o de Conte√∫do (`/admin/conteudo`)
- ‚úÖ Configura√ß√µes da Plataforma (`/admin/configuracoes`)

---

## üîê ROW LEVEL SECURITY (RLS) - ESTRAT√âGIA

### **Princ√≠pios de Acesso**

1. **Free Users**: Acesso apenas √†s pr√≥prias an√°lises (`analysis_requests`, `analysis_results`)
2. **Paid Clients**: Acesso a todos os recursos do tier + dados do pr√≥prio neg√≥cio
3. **Team Members**: Acesso baseado em role e permiss√µes granulares
4. **Admins**: Acesso total a todas as tabelas

### **Pol√≠ticas Principais**

| Tabela | Free User | Paid Client | Team Member | Admin |
|--------|-----------|-------------|-------------|-------|
| `user_profiles` | Own profile | Own profile | View only | Full access |
| `analysis_requests` | Own analyses | Own analyses | - | Full access |
| `projects` | - | Own projects | Based on role | Full access |
| `support_tickets` | - | Own tickets | Based on role | Full access |
| `storage_items` | - | Own files (10GB) | Based on role | Full access |
| `team_members` | - | Own team | View only | Full access |
| `integrations` | - | Request & view | View only | Full access |
| `leads` | - | - | - | Full access |
| `proposals` | View if recipient | View if recipient | - | Full access |
| `platform_settings` | - | - | - | Full access |

---

## üé© "M√ÅGICO DE OZ" V1 (Manual Input)

**Tabelas com input manual:**

1. **`campaign_metrics`**
   - Flag: `manually_entered = true`
   - Campo: `entered_by` (UUID do admin)
   - Prop√≥sito: Alimentar dashboard de Ads antes das integra√ß√µes autom√°ticas

2. **`analytics_data`**
   - Flag: `manually_entered = true`
   - Campo: `entered_by` (UUID do admin)
   - Prop√≥sito: Alimentar dashboard de Analytics antes das integra√ß√µes autom√°ticas

**Fluxo:**
1. Admin acessa `/admin/clientes/[id]` (Perfil do Cliente)
2. Usa formul√°rios de input manual para inserir m√©tricas
3. Dados aparecem instantaneamente no dashboard do cliente
4. Em V1.1+, substituir por integra√ß√µes autom√°ticas via APIs

---

## üìà SCHEMA HIGHLIGHTS

### **1. USER_PROFILES (Tier System)**

```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  
  -- Tier & Type
  tier TEXT NOT NULL CHECK (tier IN ('free', 'paid')) DEFAULT 'free',
  user_type TEXT NOT NULL CHECK (user_type IN ('client', 'admin')),
  
  -- Subscription (Stripe)
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT UNIQUE,
  subscription_status TEXT,
  
  -- Usage Limits
  monthly_analysis_count INT DEFAULT 0,
  storage_used_mb NUMERIC(10,2) DEFAULT 0,
  monthly_support_tickets INT DEFAULT 0
);
```

**Limites por Tier:**
- **Free**: 3 an√°lises/m√™s, 0GB storage, 0 tickets
- **Paid**: Unlimited an√°lises, 10GB storage, unlimited tickets

---

### **2. DOMAIN_MONITORING (DNS & SSL)**

```sql
CREATE TABLE domain_monitoring (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id),
  
  -- DNS Records
  dns_a_record TEXT,
  dns_mx_record TEXT,
  dns_dmarc_record TEXT,
  dns_status TEXT CHECK (dns_status IN ('healthy', 'warning', 'critical')),
  
  -- SSL/TLS
  ssl_valid BOOLEAN,
  ssl_expiry_date DATE,
  ssl_status TEXT CHECK (ssl_status IN ('valid', 'expiring_soon', 'expired', 'invalid')),
  
  -- Blacklist Check
  is_blacklisted BOOLEAN DEFAULT false,
  blacklist_sources TEXT[]
);
```

**Features:**
- ‚úÖ Monitora registros DNS cr√≠ticos (A, MX, DMARC, SPF, DKIM)
- ‚úÖ Valida SSL/TLS e alerta antes de expirar
- ‚úÖ Verifica blacklists automaticamente

---

### **3. TEAM_MEMBERS (Collaboration)**

```sql
CREATE TABLE team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES user_profiles(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  
  -- Role & Permissions
  role TEXT NOT NULL CHECK (role IN ('owner', 'admin', 'member', 'viewer')),
  
  -- Feature Flags
  can_view_analytics BOOLEAN DEFAULT true,
  can_view_campaigns BOOLEAN DEFAULT false,
  can_manage_projects BOOLEAN DEFAULT false,
  can_create_tickets BOOLEAN DEFAULT true,
  can_manage_billing BOOLEAN DEFAULT false
);
```

**Roles:**
- **Owner**: Full access (criador da conta)
- **Admin**: Tudo exceto billing
- **Member**: Visualiza√ß√£o + tickets
- **Viewer**: Apenas visualiza√ß√£o

---

### **4. INTEGRATIONS (API Connections)**

```sql
CREATE TABLE integrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES user_profiles(id),
  
  integration_type TEXT NOT NULL CHECK (integration_type IN ('crm', 'analytics', 'ads', 'email', 'storage', 'other')),
  provider TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('requested', 'pending_approval', 'active', 'paused', 'failed')),
  
  config_encrypted JSONB,
  last_sync_at TIMESTAMPTZ
);
```

**Providers Suportados (V1.1+):**
- **Analytics**: Google Analytics, Plausible, Fathom
- **Ads**: Google Ads, Meta Ads, LinkedIn Ads
- **CRM**: HubSpot, Salesforce, Pipedrive
- **Email**: SendGrid, Mailchimp
- **Storage**: Google Drive, Dropbox

---

### **5. PLATFORM_SETTINGS (Global Config)**

```sql
CREATE TABLE platform_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  setting_key TEXT UNIQUE NOT NULL,
  setting_value JSONB NOT NULL,
  category TEXT CHECK (category IN ('arco_algorithm', 'pricing', 'features', 'integrations', 'system'))
);
```

**Default Settings:**

```json
{
  "arco_algorithm_weights": {
    "performance": 0.35,
    "security": 0.25,
    "seo": 0.20,
    "accessibility": 0.20
  },
  "free_tier_limits": {
    "monthly_analyses": 3,
    "storage_mb": 0,
    "support_tickets": 0
  },
  "paid_tier_limits": {
    "monthly_analyses": -1,
    "storage_mb": 10240,
    "support_tickets": -1
  }
}
```

---

## üöÄ MIGRATION STATUS

### **Migration 001: Complete Schema**
- ‚úÖ 21 tabelas criadas
- ‚úÖ 70+ indexes otimizados
- ‚úÖ 10 triggers (updated_at)
- ‚úÖ 3 default settings inseridas
- **File:** `20250105000000_mvp_v1_complete_schema.sql`

### **Migration 002: RLS Policies**
- ‚úÖ 60+ pol√≠ticas de seguran√ßa
- ‚úÖ 4 helper functions
- ‚úÖ 1 storage bucket (`client-files`)
- ‚úÖ Storage bucket policies
- **File:** `20250105000001_rls_policies.sql`

---

## üìä RELACIONAMENTOS (ER DIAGRAM)

```
auth.users (Supabase Auth)
    ‚Üì
user_profiles (tier, user_type)
    ‚Üì
    ‚îú‚îÄ‚îÄ analysis_requests ‚Üí analysis_results
    ‚îú‚îÄ‚îÄ projects ‚Üí project_milestones
    ‚îÇ            ‚Üí performance_metrics
    ‚îÇ            ‚Üí uptime_checks
    ‚îÇ            ‚Üí domain_monitoring
    ‚îÇ            ‚Üí analytics_data
    ‚îú‚îÄ‚îÄ campaigns ‚Üí campaign_metrics
    ‚îú‚îÄ‚îÄ support_tickets ‚Üí support_ticket_messages
    ‚îú‚îÄ‚îÄ storage_items
    ‚îú‚îÄ‚îÄ agency_insights
    ‚îú‚îÄ‚îÄ integrations
    ‚îú‚îÄ‚îÄ team_members
    ‚îú‚îÄ‚îÄ leads ‚Üí proposals
    ‚îî‚îÄ‚îÄ (Stripe via stripe_customer_id)
```

---

## ‚úÖ FEATURES vs DATABASE MAPPING

### **Portal de Diagn√≥stico (Free User)**

| Feature | Tabelas Usadas | Status |
|---------|----------------|--------|
| Relat√≥rio Consolidado | `analysis_requests`, `analysis_results` | ‚úÖ Ready |
| An√°lise de Performance | `analysis_results` | ‚úÖ Ready |
| An√°lise de Seguran√ßa | `analysis_results` | ‚úÖ Ready |
| An√°lise de Dom√≠nio | `domain_monitoring` | ‚úÖ Ready |
| Sum√°rio de Otimiza√ß√µes | `analysis_results`, `playbooks` | ‚úÖ Ready |
| Simulador de Impacto | `analysis_results` (client-side) | ‚úÖ Ready |
| Comparativo de Planos | `platform_settings` (pricing) | ‚úÖ Ready |
| Agendar An√°lise | `leads` | ‚úÖ Ready |

### **Central do Cliente (Paid Client)**

| Feature | Tabelas Usadas | Status |
|---------|----------------|--------|
| Painel Estrat√©gico | `performance_metrics`, `agency_insights` | ‚úÖ Ready |
| Performance Cont√≠nua | `performance_metrics` | ‚úÖ Ready |
| Seguran√ßa Ativa | `domain_monitoring`, `analysis_results` | ‚úÖ Ready |
| Sa√∫de de Dom√≠nio & Uptime | `domain_monitoring`, `uptime_checks` | ‚úÖ Ready |
| An√°lise de Tr√°fego Web | `analytics_data` | ‚úÖ Ready (Manual V1) |
| Performance de M√≠dia Paga | `campaigns`, `campaign_metrics` | ‚úÖ Ready (Manual V1) |
| Gest√£o de Projetos | `projects`, `project_milestones` | ‚úÖ Ready |
| Central de Suporte | `support_tickets`, `support_ticket_messages` | ‚úÖ Ready |
| Reposit√≥rio de Arquivos | `storage_items` | ‚úÖ Ready |
| Portal de Faturamento | Stripe SDK (external) | ‚úÖ Ready |
| Gest√£o de Equipe | `team_members` | ‚úÖ Ready |
| Conex√µes (Integra√ß√µes) | `integrations` | ‚úÖ Ready |

### **Painel de Controle (Admin)**

| Feature | Tabelas Usadas | Status |
|---------|----------------|--------|
| Painel da Ag√™ncia | `user_profiles`, Stripe API, PostgreSQL Functions | ‚úÖ Ready |
| Gest√£o de Clientes | `user_profiles` | ‚úÖ Ready |
| Perfil do Cliente | `user_profiles`, todas as tabelas do cliente | ‚úÖ Ready |
| Pipeline de Vendas | `leads`, `proposals` | ‚úÖ Ready |
| Gerador de Propostas | `leads`, `analysis_results`, `proposals` | ‚úÖ Ready |
| Opera√ß√µes Globais | `projects`, `support_tickets` | ‚úÖ Ready |
| Gest√£o de Conte√∫do | `playbooks`, `agency_insights` | ‚úÖ Ready |
| Configura√ß√µes da Plataforma | `platform_settings` | ‚úÖ Ready |

---

## üéØ PR√ìXIMOS PASSOS

### **1. Aplicar Migrations**
```bash
npx supabase db push
```

### **2. Gerar TypeScript Types**
```bash
npx supabase gen types typescript --local > src/types/database.types.ts
```

### **3. Criar Drizzle Schema**
```bash
# Arquivo: src/lib/db/schema.ts
# Usar migration SQL como refer√™ncia
```

### **4. Implementar Features**
Seguir roadmap de 6 semanas do `MVP_V1_BLUEPRINT_FINAL.md`

---

## üìö REFER√äNCIAS

- **Blueprint Source:** Open Source Navigation & Features Draft
- **Main Doc:** `docs/MVP_V1_BLUEPRINT_FINAL.md`
- **Tech Stack:** `docs/TECH_STACK_COMPLETE.md`
- **Work Plan:** `docs/FREE_TIER_ANALYSIS_WORK_PLAN.md`
- **Migrations:** `supabase/migrations/`

---

**Status:** ‚úÖ Database Architecture Complete  
**Date:** 2025-01-05  
**Version:** 1.0  
**Total Tables:** 21  
**Total Features:** 24 (8 Free + 12 Paid + 8 Admin)
